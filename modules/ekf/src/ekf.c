#include "modules/ekf/ekf.h"
#include "lib/geo/physical_constants.h"
#include <stdint.h>
#include <math.h>
#include <string.h>

void ekf_init(ekf_data_t *data, ekf_config_t config, ekf_state_t startingState)
{
    data->state = startingState;
    data->config = config;

    memset(data->P, 0, sizeof(data->P));
    memset(data->P_Next, 0, sizeof(data->P_Next));
    memset(data->H, 0, sizeof(data->H));
    memset(data->K, 0, sizeof(data->K));
    memset(data->KH, 0, sizeof(data->KH));

    for (size_t i = 0; i < EKF_NUM_STATES; i++)
    {
        data->P[i][i] = 500.0f;
    }
}

void ekf_predict_state(ekf_data_t *data, const ekf_controls_t *controls)
{
    const float dt = data->config.dt;

    vec3_t gyroTruth = vec3_sub(&controls->gyro, &data->state.gyroBias);
    vec3_t accTruth = vec3_sub(&controls->accel, &data->state.accelBias);
    rotate_vec_through_quat(&accTruth, &data->state.orientation);
    vec3_t gravityVector = {0, 0, EARTH_GRAVITY};
    vec3_t correctedAcc = vec3_add(&accTruth, &gravityVector);

    quat_t rotationQuat = {1.0f, gyroTruth.x * dt / 2.0f, gyroTruth.y * dt / 2.0f, gyroTruth.z * dt / 2.0f};
    quat_t q_new = quat_mul(&data->state.orientation, &rotationQuat);
    quat_normalize(&q_new);

    vec3_t vel_new = {
        .x = data->state.velocity_ned.x + correctedAcc.x * dt,
        .y = data->state.velocity_ned.y + correctedAcc.y * dt,
        .z = data->state.velocity_ned.z + correctedAcc.z * dt,
    };

    vec3_t pos_new = {
        .x = data->state.position_ned.x + data->state.velocity_ned.x * dt,
        .y = data->state.position_ned.y + data->state.velocity_ned.y * dt,
        .z = data->state.position_ned.z + data->state.velocity_ned.z * dt,
    };

    vec3_t gyroBias_new = data->state.gyroBias;
    vec3_t accelBias_new = data->state.accelBias;
    vec3_t mag_new = data->state.mag_ned;
    vec3_t magBias_new = data->state.magBias;

    data->state.orientation = q_new;
    data->state.velocity_ned = vel_new;
    data->state.position_ned = pos_new;
    data->state.gyroBias = gyroBias_new;
    data->state.accelBias = accelBias_new;
    data->state.mag_ned = mag_new;
    data->state.magBias = magBias_new;
}

void ekf_predict_covariance(ekf_data_t *data, const ekf_controls_t *controls)
{
    const float q_w = data->state.orientation.w;
    const float q_x = data->state.orientation.x;
    const float q_y = data->state.orientation.y;
    const float q_z = data->state.orientation.z;
    const float gyro_x_bias = data->state.gyroBias.x;
    const float gyro_y_bias = data->state.gyroBias.y;
    const float gyro_z_bias = data->state.gyroBias.z;
    const float accel_x_bias = data->state.accelBias.x;
    const float accel_y_bias = data->state.accelBias.y;
    const float accel_z_bias = data->state.accelBias.z;
    const float gyro_x = controls->gyro.x;
    const float gyro_y = controls->gyro.y;
    const float gyro_z = controls->gyro.z;
    const float accel_x = controls->accel.x;
    const float accel_y = controls->accel.y;
    const float accel_z = controls->accel.z;
    const float dt = data->config.dt;
    const float sigma_gyro_x = data->config.gyroVariance;
    const float sigma_gyro_y = data->config.gyroVariance;
    const float sigma_gyro_z = data->config.gyroVariance;
    const float sigma_accel_x = data->config.accelVariance;
    const float sigma_accel_y = data->config.accelVariance;
    const float sigma_accel_z = data->config.accelVariance;

    const float PS0 = dt * q_x;
    const float PS1 = PS0 * data->P[0][10];
    const float PS2 = dt * q_y;
    const float PS3 = PS2 * data->P[0][11];
    const float PS4 = dt * q_z;
    const float PS5 = PS4 * data->P[0][12];
    const float PS6 = dt * (gyro_x - gyro_x_bias);
    const float PS7 = PS6 * data->P[0][1];
    const float PS8 = (1.0F / 2.0F) * PS7;
    const float PS9 = dt * (gyro_y - gyro_y_bias);
    const float PS10 = PS9 * data->P[0][2];
    const float PS11 = (1.0F / 2.0F) * PS10;
    const float PS12 = dt * (gyro_z - gyro_z_bias);
    const float PS13 = PS12 * data->P[0][3];
    const float PS14 = (1.0F / 2.0F) * PS13;
    const float PS15 = powf(q_x, 2);
    const float PS16 = powf(dt, 2);
    const float PS17 = (1.0F / 4.0F) * PS16;
    const float PS18 = PS17 * sigma_gyro_x;
    const float PS19 = powf(q_y, 2);
    const float PS20 = PS17 * sigma_gyro_y;
    const float PS21 = powf(q_z, 2);
    const float PS22 = PS17 * sigma_gyro_z;
    const float PS23 = 2 * data->P[0][10];
    const float PS24 = PS0 * data->P[10][10];
    const float PS25 = PS2 * data->P[10][11];
    const float PS26 = PS4 * data->P[10][12];
    const float PS27 = PS6 * data->P[1][10];
    const float PS28 = PS9 * data->P[2][10];
    const float PS29 = PS12 * data->P[3][10];
    const float PS30 = (1.0F / 4.0F) * PS23 + (1.0F / 4.0F) * PS24 + (1.0F / 4.0F) * PS25 + (1.0F / 4.0F) * PS26 - 1.0F / 4.0F * PS27 - 1.0F / 4.0F * PS28 - 1.0F / 4.0F * PS29;
    const float PS31 = 2 * data->P[0][11];
    const float PS32 = PS0 * data->P[10][11];
    const float PS33 = PS2 * data->P[11][11];
    const float PS34 = PS4 * data->P[11][12];
    const float PS35 = PS6 * data->P[1][11];
    const float PS36 = PS9 * data->P[2][11];
    const float PS37 = PS12 * data->P[3][11];
    const float PS38 = PS31 + PS32 + PS33 + PS34 - PS35 - PS36 - PS37;
    const float PS39 = (1.0F / 4.0F) * PS2;
    const float PS40 = 2 * data->P[0][12];
    const float PS41 = PS0 * data->P[10][12];
    const float PS42 = PS2 * data->P[11][12];
    const float PS43 = PS4 * data->P[12][12];
    const float PS44 = PS6 * data->P[1][12];
    const float PS45 = PS9 * data->P[2][12];
    const float PS46 = PS12 * data->P[3][12];
    const float PS47 = PS40 + PS41 + PS42 + PS43 - PS44 - PS45 - PS46;
    const float PS48 = (1.0F / 4.0F) * PS4;
    const float PS49 = 2 * data->P[0][1];
    const float PS50 = PS0 * data->P[1][10];
    const float PS51 = PS2 * data->P[1][11];
    const float PS52 = PS4 * data->P[1][12];
    const float PS53 = PS6 * data->P[1][1];
    const float PS54 = PS9 * data->P[1][2];
    const float PS55 = PS12 * data->P[1][3];
    const float PS56 = -PS55;
    const float PS57 = PS49 + PS50 + PS51 + PS52 - PS53 - PS54 + PS56;
    const float PS58 = (1.0F / 4.0F) * PS6;
    const float PS59 = 2 * data->P[0][2];
    const float PS60 = PS0 * data->P[2][10];
    const float PS61 = PS2 * data->P[2][11];
    const float PS62 = PS4 * data->P[2][12];
    const float PS63 = PS6 * data->P[1][2];
    const float PS64 = -PS63;
    const float PS65 = PS9 * data->P[2][2];
    const float PS66 = PS12 * data->P[2][3];
    const float PS67 = PS59 + PS60 + PS61 + PS62 + PS64 - PS65 - PS66;
    const float PS68 = (1.0F / 4.0F) * PS9;
    const float PS69 = 2 * data->P[0][3];
    const float PS70 = PS0 * data->P[3][10];
    const float PS71 = PS2 * data->P[3][11];
    const float PS72 = PS4 * data->P[3][12];
    const float PS73 = PS6 * data->P[1][3];
    const float PS74 = PS9 * data->P[2][3];
    const float PS75 = -PS74;
    const float PS76 = PS12 * data->P[3][3];
    const float PS77 = PS69 + PS70 + PS71 + PS72 - PS73 + PS75 - PS76;
    const float PS78 = (1.0F / 4.0F) * PS12;
    const float PS79 = q_w * q_x;
    const float PS80 = q_y * q_z;
    const float PS81 = -1.0F / 2.0F * PS55;
    const float PS82 = dt * q_w;
    const float PS83 = 2 * data->P[0][0];
    const float PS84 = PS1 - PS10 - PS13 + PS3 + PS5 - PS7 + PS83;
    const float PS85 = q_w * q_y;
    const float PS86 = q_x * q_z;
    const float PS87 = (1.0F / 2.0F) * PS66;
    const float PS88 = (1.0F / 4.0F) * PS82;
    const float PS89 = (1.0F / 4.0F) * PS0;
    const float PS90 = q_w * q_z;
    const float PS91 = q_x * q_y;
    const float PS92 = -1.0F / 2.0F * PS74;
    const float PS93 = data->P[4][10] * dt;
    const float PS94 = PS93 * q_x;
    const float PS95 = data->P[4][11] * dt;
    const float PS96 = PS95 * q_y;
    const float PS97 = data->P[4][12] * dt;
    const float PS98 = PS97 * q_z;
    const float PS99 = PS6 * data->P[1][4];
    const float PS100 = PS9 * data->P[2][4];
    const float PS101 = PS12 * data->P[3][4];
    const float PS102 = PS85 + PS86;
    const float PS103 = 2 * data->P[0][15];
    const float PS104 = PS0 * data->P[10][15];
    const float PS105 = PS2 * data->P[11][15];
    const float PS106 = PS4 * data->P[12][15];
    const float PS107 = PS6 * data->P[1][15];
    const float PS108 = PS9 * data->P[2][15];
    const float PS109 = PS12 * data->P[3][15];
    const float PS110 = dt * (PS103 + PS104 + PS105 + PS106 - PS107 - PS108 - PS109);
    const float PS111 = PS90 - PS91;
    const float PS112 = 2 * data->P[0][14];
    const float PS113 = PS0 * data->P[10][14];
    const float PS114 = PS2 * data->P[11][14];
    const float PS115 = PS4 * data->P[12][14];
    const float PS116 = PS6 * data->P[1][14];
    const float PS117 = PS9 * data->P[2][14];
    const float PS118 = PS12 * data->P[3][14];
    const float PS119 = dt * (PS112 + PS113 + PS114 + PS115 - PS116 - PS117 - PS118);
    const float PS120 = 2 * PS19;
    const float PS121 = 2 * PS21 - 1;
    const float PS122 = PS120 + PS121;
    const float PS123 = 2 * data->P[0][13];
    const float PS124 = PS0 * data->P[10][13];
    const float PS125 = PS2 * data->P[11][13];
    const float PS126 = PS4 * data->P[12][13];
    const float PS127 = PS6 * data->P[1][13];
    const float PS128 = PS9 * data->P[2][13];
    const float PS129 = PS12 * data->P[3][13];
    const float PS130 = dt * (PS123 + PS124 + PS125 + PS126 - PS127 - PS128 - PS129);
    const float PS131 = accel_y - accel_y_bias;
    const float PS132 = PS131 * q_y;
    const float PS133 = accel_z - accel_z_bias;
    const float PS134 = PS133 * q_z;
    const float PS135 = PS132 + PS134;
    const float PS136 = PS57 * dt;
    const float PS137 = PS133 * q_y;
    const float PS138 = PS131 * q_z;
    const float PS139 = -PS138;
    const float PS140 = PS137 + PS139;
    const float PS141 = PS84 * dt;
    const float PS142 = PS133 * q_w;
    const float PS143 = PS131 * q_x;
    const float PS144 = accel_x - accel_x_bias;
    const float PS145 = PS144 * q_y;
    const float PS146 = PS142 + PS143 - 2 * PS145;
    const float PS147 = PS67 * dt;
    const float PS148 = PS131 * q_w;
    const float PS149 = PS133 * q_x;
    const float PS150 = PS144 * q_z;
    const float PS151 = PS148 - PS149 + 2 * PS150;
    const float PS152 = PS77 * dt;
    const float PS153 = data->P[5][10] * dt;
    const float PS154 = PS153 * q_x;
    const float PS155 = data->P[5][11] * dt;
    const float PS156 = PS155 * q_y;
    const float PS157 = data->P[5][12] * dt;
    const float PS158 = PS157 * q_z;
    const float PS159 = PS6 * data->P[1][5];
    const float PS160 = PS9 * data->P[2][5];
    const float PS161 = PS12 * data->P[3][5];
    const float PS162 = PS79 - PS80;
    const float PS163 = PS90 + PS91;
    const float PS164 = 2 * PS15;
    const float PS165 = PS121 + PS164;
    const float PS166 = PS144 * q_x;
    const float PS167 = PS134 + PS166;
    const float PS168 = PS149 - PS150;
    const float PS169 = PS144 * q_w;
    const float PS170 = PS137 - 2 * PS138 + PS169;
    const float PS171 = -PS145;
    const float PS172 = PS142 + 2 * PS143 + PS171;
    const float PS173 = data->P[6][10] * dt;
    const float PS174 = PS173 * q_x;
    const float PS175 = data->P[6][11] * dt;
    const float PS176 = PS175 * q_y;
    const float PS177 = data->P[6][12] * dt;
    const float PS178 = PS177 * q_z;
    const float PS179 = PS6 * data->P[1][6];
    const float PS180 = PS9 * data->P[2][6];
    const float PS181 = PS12 * data->P[3][6];
    const float PS182 = PS79 + PS80;
    const float PS183 = PS85 - PS86;
    const float PS184 = PS120 + PS164 - 1;
    const float PS185 = PS132 + PS166;
    const float PS186 = PS143 + PS171;
    const float PS187 = PS148 - 2 * PS149 + PS150;
    const float PS188 = 2 * PS137 + PS139 + PS169;
    const float PS189 = (1.0F / 2.0F) * PS0;
    const float PS190 = (1.0F / 2.0F) * PS2;
    const float PS191 = (1.0F / 2.0F) * PS4;
    const float PS192 = (1.0F / 2.0F) * PS6;
    const float PS193 = (1.0F / 2.0F) * PS9;
    const float PS194 = (1.0F / 2.0F) * PS12;
    const float PS195 = 2 * data->P[0][4];
    const float PS196 = (1.0F / 2.0F) * dt;
    const float PS197 = 2 * data->P[0][5];
    const float PS198 = 2 * data->P[0][6];
    const float PS199 = (1.0F / 2.0F) * PS25;
    const float PS200 = (1.0F / 2.0F) * PS26;
    const float PS201 = (1.0F / 2.0F) * PS32;
    const float PS202 = (1.0F / 2.0F) * PS34;
    const float PS203 = (1.0F / 2.0F) * PS41;
    const float PS204 = (1.0F / 2.0F) * PS42;
    const float PS205 = PS196 * q_w;
    const float PS206 = PS4 * data->P[1][11];
    const float PS207 = PS2 * data->P[1][12];
    const float PS208 = PS12 * data->P[1][2];
    const float PS209 = (1.0F / 2.0F) * PS208;
    const float PS210 = PS9 * data->P[1][3];
    const float PS211 = (1.0F / 2.0F) * PS210;
    const float PS212 = powf(q_w, 2);
    const float PS213 = 2 * data->P[1][10];
    const float PS214 = PS4 * data->P[10][11];
    const float PS215 = PS2 * data->P[10][12];
    const float PS216 = PS6 * data->P[0][10];
    const float PS217 = PS12 * data->P[2][10];
    const float PS218 = PS9 * data->P[3][10];
    const float PS219 = PS213 + PS214 - PS215 + PS216 + PS217 - PS218 - PS82 * data->P[10][10];
    const float PS220 = 2 * data->P[1][12];
    const float PS221 = -PS82 * data->P[10][12];
    const float PS222 = PS2 * data->P[12][12];
    const float PS223 = PS6 * data->P[0][12];
    const float PS224 = PS12 * data->P[2][12];
    const float PS225 = PS9 * data->P[3][12];
    const float PS226 = PS220 + PS221 - PS222 + PS223 + PS224 - PS225 + PS34;
    const float PS227 = 2 * data->P[1][11];
    const float PS228 = PS4 * data->P[11][11];
    const float PS229 = -PS82 * data->P[10][11];
    const float PS230 = PS6 * data->P[0][11];
    const float PS231 = PS12 * data->P[2][11];
    const float PS232 = PS9 * data->P[3][11];
    const float PS233 = PS227 + PS228 + PS229 + PS230 + PS231 - PS232 - PS42;
    const float PS234 = PS12 * data->P[0][2];
    const float PS235 = PS9 * data->P[0][3];
    const float PS236 = -PS2 * data->P[0][12] + PS234 - PS235 + PS4 * data->P[0][11] + PS49 + PS6 * data->P[0][0] - PS82 * data->P[0][10];
    const float PS237 = 2 * data->P[1][3];
    const float PS238 = PS4 * data->P[3][11];
    const float PS239 = PS2 * data->P[3][12];
    const float PS240 = PS6 * data->P[0][3];
    const float PS241 = PS9 * data->P[3][3];
    const float PS242 = PS237 + PS238 - PS239 + PS240 - PS241 + PS66 - PS82 * data->P[3][10];
    const float PS243 = 2 * data->P[1][2];
    const float PS244 = PS4 * data->P[2][11];
    const float PS245 = PS2 * data->P[2][12];
    const float PS246 = PS6 * data->P[0][2];
    const float PS247 = PS12 * data->P[2][2];
    const float PS248 = PS243 + PS244 - PS245 + PS246 + PS247 + PS75 - PS82 * data->P[2][10];
    const float PS249 = 2 * data->P[1][1];
    const float PS250 = PS206 - PS207 + PS208 - PS210 + PS249 + PS7 - PS82 * data->P[1][10];
    const float PS251 = PS93 * q_w;
    const float PS252 = PS95 * q_z;
    const float PS253 = PS97 * q_y;
    const float PS254 = PS6 * data->P[0][4];
    const float PS255 = PS12 * data->P[2][4];
    const float PS256 = PS9 * data->P[3][4];
    const float PS257 = 2 * data->P[1][15];
    const float PS258 = PS4 * data->P[11][15];
    const float PS259 = PS2 * data->P[12][15];
    const float PS260 = PS6 * data->P[0][15];
    const float PS261 = PS12 * data->P[2][15];
    const float PS262 = PS9 * data->P[3][15];
    const float PS263 = PS257 + PS258 - PS259 + PS260 + PS261 - PS262 - PS82 * data->P[10][15];
    const float PS264 = PS263 * dt;
    const float PS265 = 2 * data->P[1][14];
    const float PS266 = PS4 * data->P[11][14];
    const float PS267 = PS2 * data->P[12][14];
    const float PS268 = PS6 * data->P[0][14];
    const float PS269 = PS12 * data->P[2][14];
    const float PS270 = PS9 * data->P[3][14];
    const float PS271 = PS265 + PS266 - PS267 + PS268 + PS269 - PS270 - PS82 * data->P[10][14];
    const float PS272 = PS271 * dt;
    const float PS273 = 2 * data->P[1][13];
    const float PS274 = PS4 * data->P[11][13];
    const float PS275 = PS2 * data->P[12][13];
    const float PS276 = PS6 * data->P[0][13];
    const float PS277 = PS12 * data->P[2][13];
    const float PS278 = PS9 * data->P[3][13];
    const float PS279 = PS273 + PS274 - PS275 + PS276 + PS277 - PS278 - PS82 * data->P[10][13];
    const float PS280 = PS122 * PS196;
    const float PS281 = PS250 * dt;
    const float PS282 = PS236 * dt;
    const float PS283 = PS248 * dt;
    const float PS284 = PS242 * dt;
    const float PS285 = PS153 * q_w;
    const float PS286 = PS155 * q_z;
    const float PS287 = PS157 * q_y;
    const float PS288 = PS6 * data->P[0][5];
    const float PS289 = PS12 * data->P[2][5];
    const float PS290 = PS9 * data->P[3][5];
    const float PS291 = PS279 * dt;
    const float PS292 = PS165 * PS196;
    const float PS293 = PS173 * q_w;
    const float PS294 = PS175 * q_z;
    const float PS295 = PS177 * q_y;
    const float PS296 = PS6 * data->P[0][6];
    const float PS297 = PS12 * data->P[2][6];
    const float PS298 = PS9 * data->P[3][6];
    const float PS299 = PS184 * PS196;
    const float PS300 = 2 * data->P[1][4];
    const float PS301 = 2 * data->P[1][5];
    const float PS302 = 2 * data->P[1][6];
    const float PS303 = (1.0F / 2.0F) * PS214;
    const float PS304 = (1.0F / 2.0F) * PS215;
    const float PS305 = -PS205 * data->P[10][11];
    const float PS306 = -PS205 * data->P[10][12];
    const float PS307 = PS4 * data->P[2][10];
    const float PS308 = PS0 * data->P[2][12];
    const float PS309 = PS6 * data->P[2][3];
    const float PS310 = (1.0F / 2.0F) * PS309;
    const float PS311 = 2 * data->P[2][11];
    const float PS312 = PS0 * data->P[11][12];
    const float PS313 = PS9 * data->P[0][11];
    const float PS314 = PS6 * data->P[3][11];
    const float PS315 = PS12 * data->P[1][11];
    const float PS316 = -PS214 + PS311 + PS312 + PS313 + PS314 - PS315 - PS82 * data->P[11][11];
    const float PS317 = 2 * data->P[2][12];
    const float PS318 = PS0 * data->P[12][12];
    const float PS319 = -PS82 * data->P[11][12];
    const float PS320 = PS9 * data->P[0][12];
    const float PS321 = PS6 * data->P[3][12];
    const float PS322 = PS12 * data->P[1][12];
    const float PS323 = -PS26 + PS317 + PS318 + PS319 + PS320 + PS321 - PS322;
    const float PS324 = 2 * data->P[2][10];
    const float PS325 = PS4 * data->P[10][10];
    const float PS326 = PS9 * data->P[0][10];
    const float PS327 = PS6 * data->P[3][10];
    const float PS328 = PS12 * data->P[1][10];
    const float PS329 = PS229 + PS324 - PS325 + PS326 + PS327 - PS328 + PS41;
    const float PS330 = 2 * data->P[2][3];
    const float PS331 = PS0 * data->P[3][12];
    const float PS332 = PS4 * data->P[3][10];
    const float PS333 = PS6 * data->P[3][3];
    const float PS334 = PS235 + PS330 + PS331 - PS332 + PS333 + PS56 - PS82 * data->P[3][11];
    const float PS335 = PS12 * data->P[0][1];
    const float PS336 = PS0 * data->P[0][12] + PS240 - PS335 - PS4 * data->P[0][10] + PS59 - PS82 * data->P[0][11] + PS9 * data->P[0][0];
    const float PS337 = PS9 * data->P[0][1];
    const float PS338 = PS0 * data->P[1][12] - PS12 * data->P[1][1] + PS243 + PS337 - PS4 * data->P[1][10] + PS73 - PS82 * data->P[1][11];
    const float PS339 = 2 * data->P[2][2];
    const float PS340 = PS10 - PS208 - PS307 + PS308 + PS309 + PS339 - PS82 * data->P[2][11];
    const float PS341 = PS93 * q_z;
    const float PS342 = PS95 * q_w;
    const float PS343 = PS97 * q_x;
    const float PS344 = PS9 * data->P[0][4];
    const float PS345 = PS12 * data->P[1][4];
    const float PS346 = PS6 * data->P[3][4];
    const float PS347 = 2 * data->P[2][15];
    const float PS348 = PS0 * data->P[12][15];
    const float PS349 = PS4 * data->P[10][15];
    const float PS350 = PS9 * data->P[0][15];
    const float PS351 = PS6 * data->P[3][15];
    const float PS352 = PS12 * data->P[1][15];
    const float PS353 = PS347 + PS348 - PS349 + PS350 + PS351 - PS352 - PS82 * data->P[11][15];
    const float PS354 = PS353 * dt;
    const float PS355 = 2 * data->P[2][14];
    const float PS356 = PS0 * data->P[12][14];
    const float PS357 = PS4 * data->P[10][14];
    const float PS358 = PS9 * data->P[0][14];
    const float PS359 = PS6 * data->P[3][14];
    const float PS360 = PS12 * data->P[1][14];
    const float PS361 = PS355 + PS356 - PS357 + PS358 + PS359 - PS360 - PS82 * data->P[11][14];
    const float PS362 = PS361 * dt;
    const float PS363 = 2 * data->P[2][13];
    const float PS364 = PS0 * data->P[12][13];
    const float PS365 = PS4 * data->P[10][13];
    const float PS366 = PS9 * data->P[0][13];
    const float PS367 = PS6 * data->P[3][13];
    const float PS368 = PS12 * data->P[1][13];
    const float PS369 = PS363 + PS364 - PS365 + PS366 + PS367 - PS368 - PS82 * data->P[11][13];
    const float PS370 = PS338 * dt;
    const float PS371 = PS336 * dt;
    const float PS372 = PS340 * dt;
    const float PS373 = PS334 * dt;
    const float PS374 = PS153 * q_z;
    const float PS375 = PS155 * q_w;
    const float PS376 = PS157 * q_x;
    const float PS377 = PS9 * data->P[0][5];
    const float PS378 = PS12 * data->P[1][5];
    const float PS379 = PS6 * data->P[3][5];
    const float PS380 = PS369 * dt;
    const float PS381 = PS173 * q_z;
    const float PS382 = PS175 * q_w;
    const float PS383 = PS177 * q_x;
    const float PS384 = PS9 * data->P[0][6];
    const float PS385 = PS12 * data->P[1][6];
    const float PS386 = PS6 * data->P[3][6];
    const float PS387 = 2 * data->P[2][4];
    const float PS388 = 2 * data->P[2][5];
    const float PS389 = 2 * data->P[2][6];
    const float PS390 = (1.0F / 2.0F) * PS312;
    const float PS391 = -PS205 * data->P[11][12];
    const float PS392 = PS2 * data->P[3][10];
    const float PS393 = PS0 * data->P[3][11];
    const float PS394 = 2 * data->P[3][12];
    const float PS395 = PS12 * data->P[0][12];
    const float PS396 = PS9 * data->P[1][12];
    const float PS397 = PS6 * data->P[2][12];
    const float PS398 = 2 * data->P[3][11];
    const float PS399 = PS0 * data->P[11][11];
    const float PS400 = PS12 * data->P[0][11];
    const float PS401 = PS9 * data->P[1][11];
    const float PS402 = PS6 * data->P[2][11];
    const float PS403 = 2 * data->P[3][10];
    const float PS404 = PS2 * data->P[10][10];
    const float PS405 = PS12 * data->P[0][10];
    const float PS406 = PS9 * data->P[1][10];
    const float PS407 = PS6 * data->P[2][10];
    const float PS408 = -PS0 * data->P[2][11] + PS2 * data->P[2][10] + PS234 + PS330 + PS54 - PS6 * data->P[2][2] - PS82 * data->P[2][12];
    const float PS409 = -PS0 * data->P[1][11] + PS2 * data->P[1][10] + PS237 + PS335 + PS64 - PS82 * data->P[1][12] + PS9 * data->P[1][1];
    const float PS410 = -PS0 * data->P[0][11] + PS12 * data->P[0][0] + PS2 * data->P[0][10] - PS246 + PS337 + PS69 - PS82 * data->P[0][12];
    const float PS411 = PS93 * q_y;
    const float PS412 = PS95 * q_x;
    const float PS413 = PS97 * q_w;
    const float PS414 = PS12 * data->P[0][4];
    const float PS415 = PS9 * data->P[1][4];
    const float PS416 = PS6 * data->P[2][4];
    const float PS417 = 2 * data->P[3][15];
    const float PS418 = PS2 * data->P[10][15];
    const float PS419 = PS0 * data->P[11][15];
    const float PS420 = PS12 * data->P[0][15];
    const float PS421 = PS9 * data->P[1][15];
    const float PS422 = PS6 * data->P[2][15];
    const float PS423 = PS417 + PS418 - PS419 + PS420 + PS421 - PS422 - PS82 * data->P[12][15];
    const float PS424 = PS423 * dt;
    const float PS425 = 2 * data->P[3][14];
    const float PS426 = PS2 * data->P[10][14];
    const float PS427 = PS0 * data->P[11][14];
    const float PS428 = PS12 * data->P[0][14];
    const float PS429 = PS9 * data->P[1][14];
    const float PS430 = PS6 * data->P[2][14];
    const float PS431 = PS425 + PS426 - PS427 + PS428 + PS429 - PS430 - PS82 * data->P[12][14];
    const float PS432 = PS431 * dt;
    const float PS433 = 2 * data->P[3][13];
    const float PS434 = PS2 * data->P[10][13];
    const float PS435 = PS0 * data->P[11][13];
    const float PS436 = PS12 * data->P[0][13];
    const float PS437 = PS9 * data->P[1][13];
    const float PS438 = PS6 * data->P[2][13];
    const float PS439 = PS433 + PS434 - PS435 + PS436 + PS437 - PS438 - PS82 * data->P[12][13];
    const float PS440 = PS409 * dt;
    const float PS441 = PS410 * dt;
    const float PS442 = PS408 * dt;
    const float PS443 = 2 * data->P[3][3];
    const float PS444 = dt * (PS13 + PS210 - PS309 + PS392 - PS393 + PS443 - PS82 * data->P[3][12]);
    const float PS445 = PS153 * q_y;
    const float PS446 = PS155 * q_x;
    const float PS447 = PS157 * q_w;
    const float PS448 = PS12 * data->P[0][5];
    const float PS449 = PS9 * data->P[1][5];
    const float PS450 = PS6 * data->P[2][5];
    const float PS451 = PS439 * dt;
    const float PS452 = PS173 * q_y;
    const float PS453 = PS175 * q_x;
    const float PS454 = PS177 * q_w;
    const float PS455 = PS12 * data->P[0][6];
    const float PS456 = PS9 * data->P[1][6];
    const float PS457 = PS6 * data->P[2][6];
    const float PS458 = 2 * data->P[3][4];
    const float PS459 = 2 * data->P[3][5];
    const float PS460 = 2 * data->P[3][6];
    const float PS461 = 2 * dt;
    const float PS462 = PS102 * PS461;
    const float PS463 = PS111 * PS461;
    const float PS464 = PS122 * dt;
    const float PS465 = PS135 * dt;
    const float PS466 = PS140 * dt;
    const float PS467 = PS146 * dt;
    const float PS468 = PS151 * dt;
    const float PS469 = PS123 * PS466 + PS273 * PS465 + PS363 * PS467 - PS433 * PS468 - PS462 * data->P[13][15] + PS463 * data->P[13][14] + PS464 * data->P[13][13] + data->P[4][13];
    const float PS470 = PS16 * sigma_accel_x;
    const float PS471 = PS103 * PS466 + PS257 * PS465 + PS347 * PS467 - PS417 * PS468 - PS462 * data->P[15][15] + PS463 * data->P[14][15] + PS464 * data->P[13][15] + data->P[4][15];
    const float PS472 = PS102 * dt;
    const float PS473 = PS111 * dt;
    const float PS474 = PS461 * (PS237 * PS465 + PS330 * PS467 - PS417 * PS472 + PS425 * PS473 - PS443 * PS468 + PS464 * data->P[3][13] + PS466 * PS69 + data->P[3][4]);
    const float PS475 = PS112 * PS466 + PS265 * PS465 + PS355 * PS467 - PS425 * PS468 - PS462 * data->P[14][15] + PS463 * data->P[14][14] + PS464 * data->P[13][14] + data->P[4][14];
    const float PS476 = PS461 * (-PS237 * PS468 + PS243 * PS467 + PS249 * PS465 - PS257 * PS472 + PS265 * PS473 + PS464 * data->P[1][13] + PS466 * PS49 + data->P[1][4]);
    const float PS477 = PS461 * (-PS103 * PS472 + PS112 * PS473 + PS464 * data->P[0][13] + PS465 * PS49 + PS466 * PS83 + PS467 * PS59 - PS468 * PS69 + data->P[0][4]);
    const float PS478 = PS461 * (PS243 * PS465 - PS330 * PS468 + PS339 * PS467 - PS347 * PS472 + PS355 * PS473 + PS464 * data->P[2][13] + PS466 * PS59 + data->P[2][4]);
    const float PS479 = PS16 * sigma_accel_y;
    const float PS480 = 4 * PS479;
    const float PS481 = PS16 * sigma_accel_z;
    const float PS482 = 4 * PS481;
    const float PS483 = data->P[4][15] * dt;
    const float PS484 = 2 * PS102;
    const float PS485 = data->P[4][14] * dt;
    const float PS486 = 2 * PS111;
    const float PS487 = data->P[4][13] * dt;
    const float PS488 = PS122 * PS487 + PS195 * PS466 + PS300 * PS465 + PS387 * PS467 - PS458 * PS468 - PS483 * PS484 + PS485 * PS486 + data->P[4][4];
    const float PS489 = PS165 * dt;
    const float PS490 = PS461 * PS469;
    const float PS491 = PS162 * PS461;
    const float PS492 = 2 * PS163;
    const float PS493 = PS122 * PS470;
    const float PS494 = PS165 * PS479;
    const float PS495 = data->P[5][15] * dt;
    const float PS496 = data->P[5][14] * dt;
    const float PS497 = data->P[5][13] * dt;
    const float PS498 = PS122 * PS497 + PS197 * PS466 + PS301 * PS465 + PS388 * PS467 - PS459 * PS468 - PS484 * PS495 + PS486 * PS496 + data->P[4][5];
    const float PS499 = PS184 * dt;
    const float PS500 = PS182 * PS461;
    const float PS501 = PS184 * PS481;
    const float PS502 = 2 * PS183;
    const float PS503 = data->P[6][15] * dt;
    const float PS504 = data->P[6][14] * dt;
    const float PS505 = data->P[6][13] * dt;
    const float PS506 = PS122 * PS505 + PS198 * PS466 + PS302 * PS465 + PS389 * PS467 - PS460 * PS468 - PS484 * PS503 + PS486 * PS504 + data->P[4][6];
    const float PS507 = PS135 * PS461;
    const float PS508 = PS140 * PS461;
    const float PS509 = PS146 * PS461;
    const float PS510 = PS151 * PS461;
    const float PS511 = PS163 * PS461;
    const float PS512 = PS167 * dt;
    const float PS513 = PS168 * dt;
    const float PS514 = PS170 * dt;
    const float PS515 = PS172 * dt;
    const float PS516 = -PS112 * PS513 - PS265 * PS515 + PS355 * PS512 + PS425 * PS514 + PS489 * data->P[14][14] + PS491 * data->P[14][15] - PS511 * data->P[13][14] + data->P[5][14];
    const float PS517 = -PS123 * PS513 - PS273 * PS515 + PS363 * PS512 + PS433 * PS514 + PS489 * data->P[13][14] + PS491 * data->P[13][15] - PS511 * data->P[13][13] + data->P[5][13];
    const float PS518 = PS163 * dt;
    const float PS519 = PS162 * dt;
    const float PS520 = PS461 * (PS103 * PS519 - PS123 * PS518 + PS489 * data->P[0][14] - PS49 * PS515 + PS512 * PS59 - PS513 * PS83 + PS514 * PS69 + data->P[0][5]);
    const float PS521 = PS461 * (PS237 * PS514 + PS243 * PS512 - PS249 * PS515 + PS257 * PS519 - PS273 * PS518 + PS489 * data->P[1][14] - PS49 * PS513 + data->P[1][5]);
    const float PS522 = -PS103 * PS513 - PS257 * PS515 + PS347 * PS512 + PS417 * PS514 + PS489 * data->P[14][15] + PS491 * data->P[15][15] - PS511 * data->P[13][15] + data->P[5][15];
    const float PS523 = PS461 * (-PS243 * PS515 + PS330 * PS514 + PS339 * PS512 + PS347 * PS519 - PS363 * PS518 + PS489 * data->P[2][14] - PS513 * PS59 + data->P[2][5]);
    const float PS524 = PS461 * (-PS237 * PS515 + PS330 * PS512 + PS417 * PS519 - PS433 * PS518 + PS443 * PS514 + PS489 * data->P[3][14] - PS513 * PS69 + data->P[3][5]);
    const float PS525 = 4 * PS470;
    const float PS526 = 2 * PS162;
    const float PS527 = PS165 * PS496 - PS197 * PS513 - PS301 * PS515 + PS388 * PS512 + PS459 * PS514 - PS492 * PS497 + PS495 * PS526 + data->P[5][5];
    const float PS528 = PS183 * PS461;
    const float PS529 = 2 * PS182;
    const float PS530 = PS165 * PS504 - PS198 * PS513 - PS302 * PS515 + PS389 * PS512 + PS460 * PS514 - PS492 * PS505 + PS503 * PS526 + data->P[5][6];
    const float PS531 = PS167 * PS461;
    const float PS532 = PS168 * PS461;
    const float PS533 = PS170 * PS461;
    const float PS534 = PS172 * PS461;
    const float PS535 = PS185 * dt;
    const float PS536 = PS186 * dt;
    const float PS537 = PS187 * dt;
    const float PS538 = PS188 * dt;
    const float PS539 = PS103 * PS536 + PS257 * PS537 - PS347 * PS538 + PS417 * PS535 + PS499 * data->P[15][15] - PS500 * data->P[14][15] + PS528 * data->P[13][15] + data->P[6][15];
    const float PS540 = PS112 * PS536 + PS265 * PS537 - PS355 * PS538 + PS425 * PS535 + PS499 * data->P[14][15] - PS500 * data->P[14][14] + PS528 * data->P[13][14] + data->P[6][14];
    const float PS541 = PS182 * dt;
    const float PS542 = PS183 * dt;
    const float PS543 = PS188 * PS461;
    const float PS544 = PS123 * PS536 + PS273 * PS537 - PS363 * PS538 + PS433 * PS535 + PS499 * data->P[13][15] - PS500 * data->P[13][14] + PS528 * data->P[13][13] + data->P[6][13];
    const float PS545 = PS185 * PS461;
    const float PS546 = PS186 * PS461;
    const float PS547 = PS187 * PS461;
    const float PS548 = PS184 * PS503 + PS198 * PS536 + PS302 * PS537 - PS389 * PS538 + PS460 * PS535 + PS502 * PS505 - PS504 * PS529 + data->P[6][6];

    data->P_Next[0][0] = PS0 * PS30 + (1.0F / 2.0F) * PS1 - PS11 - PS14 + PS15 * PS18 + PS19 * PS20 + PS21 * PS22 + (1.0F / 2.0F) * PS3 + PS38 * PS39 + PS47 * PS48 + (1.0F / 2.0F) * PS5 - PS57 * PS58 - PS67 * PS68 - PS77 * PS78 - PS8 + data->P[0][0];
    data->P_Next[0][1] = -PS18 * PS79 + PS20 * PS80 - PS22 * PS80 - PS30 * PS82 + PS38 * PS48 - PS39 * PS47 + (1.0F / 2.0F) * PS50 + (1.0F / 2.0F) * PS51 + (1.0F / 2.0F) * PS52 - 1.0F / 2.0F * PS53 - 1.0F / 2.0F * PS54 + PS58 * PS84 + PS67 * PS78 - PS68 * PS77 + PS81 + data->P[0][1];
    data->P_Next[1][1] = PS18 * PS212 + PS19 * PS22 + PS20 * PS21 - PS205 * data->P[1][10] + (1.0F / 2.0F) * PS206 - 1.0F / 2.0F * PS207 + PS209 - PS211 - PS219 * PS88 - PS226 * PS39 + PS233 * PS48 + PS236 * PS58 - PS242 * PS68 + PS248 * PS78 + PS8 + data->P[1][1];
    data->P_Next[0][2] = -PS18 * PS86 - PS20 * PS85 + PS22 * PS86 - PS30 * PS4 - PS38 * PS88 + PS47 * PS89 - PS57 * PS78 + PS58 * PS77 + (1.0F / 2.0F) * PS60 + (1.0F / 2.0F) * PS61 + (1.0F / 2.0F) * PS62 - 1.0F / 2.0F * PS63 - 1.0F / 2.0F * PS65 + PS68 * PS84 - PS87 + data->P[0][2];
    data->P_Next[1][2] = PS18 * PS90 - PS20 * PS90 - PS205 * data->P[2][10] - PS219 * PS48 - PS22 * PS91 + PS226 * PS89 - PS233 * PS88 + PS236 * PS68 + PS242 * PS58 + (1.0F / 2.0F) * PS244 - 1.0F / 2.0F * PS245 + (1.0F / 2.0F) * PS246 + (1.0F / 2.0F) * PS247 - PS250 * PS78 + PS92 + data->P[1][2];
    data->P_Next[2][2] = PS11 + PS15 * PS22 + PS18 * PS21 + PS20 * PS212 - PS205 * data->P[2][11] - PS209 - 1.0F / 2.0F * PS307 + (1.0F / 2.0F) * PS308 + PS310 - PS316 * PS88 + PS323 * PS89 - PS329 * PS48 + PS334 * PS58 + PS336 * PS68 - PS338 * PS78 + data->P[2][2];
    data->P_Next[0][3] = PS18 * PS91 + PS2 * PS30 - PS20 * PS91 - PS22 * PS90 - PS38 * PS89 - PS47 * PS88 + PS57 * PS68 - PS58 * PS67 + (1.0F / 2.0F) * PS70 + (1.0F / 2.0F) * PS71 + (1.0F / 2.0F) * PS72 - 1.0F / 2.0F * PS73 - 1.0F / 2.0F * PS76 + PS78 * PS84 + PS92 + data->P[0][3];
    data->P_Next[1][3] = -PS18 * PS85 - PS20 * PS86 - PS205 * data->P[3][10] + PS219 * PS39 + PS22 * PS85 - PS226 * PS88 - PS233 * PS89 + PS236 * PS78 + (1.0F / 2.0F) * PS238 - 1.0F / 2.0F * PS239 + (1.0F / 2.0F) * PS240 - 1.0F / 2.0F * PS241 - PS248 * PS58 + PS250 * PS68 + PS87 + data->P[1][3];
    data->P_Next[2][3] = -PS18 * PS80 + PS20 * PS79 - PS205 * data->P[3][11] - PS22 * PS79 + (1.0F / 2.0F) * PS235 - PS316 * PS89 - PS323 * PS88 + PS329 * PS39 + (1.0F / 2.0F) * PS331 - 1.0F / 2.0F * PS332 + (1.0F / 2.0F) * PS333 + PS336 * PS78 + PS338 * PS68 - PS340 * PS58 + PS81 + data->P[2][3];
    data->P_Next[3][3] = PS14 + PS15 * PS20 + PS18 * PS19 - PS205 * data->P[3][12] + PS211 + PS212 * PS22 - PS310 + PS39 * (PS221 - PS32 + PS403 + PS404 + PS405 + PS406 - PS407) + (1.0F / 2.0F) * PS392 - 1.0F / 2.0F * PS393 - PS408 * PS58 + PS409 * PS68 + PS410 * PS78 - PS88 * (PS215 - PS312 + PS394 + PS395 + PS396 - PS397 - PS82 * data->P[12][12]) - PS89 * (PS25 + PS319 + PS398 - PS399 + PS400 + PS401 - PS402) + data->P[3][3];
    data->P_Next[0][4] = -1.0F / 2.0F * PS100 - 1.0F / 2.0F * PS101 - PS102 * PS110 + PS111 * PS119 + (1.0F / 2.0F) * PS122 * PS130 + PS135 * PS136 + PS140 * PS141 + PS146 * PS147 - PS151 * PS152 + (1.0F / 2.0F) * PS94 + (1.0F / 2.0F) * PS96 + (1.0F / 2.0F) * PS98 - 1.0F / 2.0F * PS99 + data->P[0][4];
    data->P_Next[1][4] = -PS102 * PS264 + PS111 * PS272 + PS135 * PS281 + PS140 * PS282 + PS146 * PS283 - PS151 * PS284 - 1.0F / 2.0F * PS251 + (1.0F / 2.0F) * PS252 - 1.0F / 2.0F * PS253 + (1.0F / 2.0F) * PS254 + (1.0F / 2.0F) * PS255 - 1.0F / 2.0F * PS256 + PS279 * PS280 + data->P[1][4];
    data->P_Next[2][4] = -PS102 * PS354 + PS111 * PS362 + PS135 * PS370 + PS140 * PS371 + PS146 * PS372 - PS151 * PS373 + PS280 * PS369 - 1.0F / 2.0F * PS341 - 1.0F / 2.0F * PS342 + (1.0F / 2.0F) * PS343 + (1.0F / 2.0F) * PS344 - 1.0F / 2.0F * PS345 + (1.0F / 2.0F) * PS346 + data->P[2][4];
    data->P_Next[3][4] = -PS102 * PS424 + PS111 * PS432 + PS135 * PS440 + PS140 * PS441 + PS146 * PS442 - PS151 * PS444 + PS280 * PS439 + (1.0F / 2.0F) * PS411 - 1.0F / 2.0F * PS412 - 1.0F / 2.0F * PS413 + (1.0F / 2.0F) * PS414 + (1.0F / 2.0F) * PS415 - 1.0F / 2.0F * PS416 + data->P[3][4];
    data->P_Next[4][4] = powf(PS102, 2) * PS482 + powf(PS111, 2) * PS480 + powf(PS122, 2) * PS470 + PS135 * PS476 + PS140 * PS477 + PS146 * PS478 - PS151 * PS474 - PS462 * PS471 + PS463 * PS475 + PS464 * PS469 + PS488;
    data->P_Next[0][5] = PS110 * PS162 + (1.0F / 2.0F) * PS119 * PS165 - PS130 * PS163 - PS136 * PS172 - PS141 * PS168 + PS147 * PS167 + PS152 * PS170 + (1.0F / 2.0F) * PS154 + (1.0F / 2.0F) * PS156 + (1.0F / 2.0F) * PS158 - 1.0F / 2.0F * PS159 - 1.0F / 2.0F * PS160 - 1.0F / 2.0F * PS161 + data->P[0][5];
    data->P_Next[1][5] = PS162 * PS264 - PS163 * PS291 + PS167 * PS283 - PS168 * PS282 + PS170 * PS284 - PS172 * PS281 + PS271 * PS292 - 1.0F / 2.0F * PS285 + (1.0F / 2.0F) * PS286 - 1.0F / 2.0F * PS287 + (1.0F / 2.0F) * PS288 + (1.0F / 2.0F) * PS289 - 1.0F / 2.0F * PS290 + data->P[1][5];
    data->P_Next[2][5] = PS162 * PS354 - PS163 * PS380 + PS167 * PS372 - PS168 * PS371 + PS170 * PS373 - PS172 * PS370 + PS292 * PS361 - 1.0F / 2.0F * PS374 - 1.0F / 2.0F * PS375 + (1.0F / 2.0F) * PS376 + (1.0F / 2.0F) * PS377 - 1.0F / 2.0F * PS378 + (1.0F / 2.0F) * PS379 + data->P[2][5];
    data->P_Next[3][5] = PS162 * PS424 - PS163 * PS451 + PS167 * PS442 - PS168 * PS441 + PS170 * PS444 - PS172 * PS440 + PS292 * PS431 + (1.0F / 2.0F) * PS445 - 1.0F / 2.0F * PS446 - 1.0F / 2.0F * PS447 + (1.0F / 2.0F) * PS448 + (1.0F / 2.0F) * PS449 - 1.0F / 2.0F * PS450 + data->P[3][5];
    data->P_Next[4][5] = -PS102 * PS162 * PS482 - PS163 * PS490 + PS167 * PS478 - PS168 * PS477 + PS170 * PS474 - PS172 * PS476 + PS471 * PS491 + PS475 * PS489 + PS486 * PS494 - PS492 * PS493 + PS498;
    data->P_Next[5][5] = powf(PS162, 2) * PS482 + powf(PS163, 2) * PS525 + powf(PS165, 2) * PS479 + PS167 * PS523 - PS168 * PS520 + PS170 * PS524 - PS172 * PS521 + PS489 * PS516 + PS491 * PS522 - PS511 * PS517 + PS527;
    data->P_Next[0][6] = (1.0F / 2.0F) * PS110 * PS184 - PS119 * PS182 + PS130 * PS183 + PS136 * PS187 + PS141 * PS186 - PS147 * PS188 + PS152 * PS185 + (1.0F / 2.0F) * PS174 + (1.0F / 2.0F) * PS176 + (1.0F / 2.0F) * PS178 - 1.0F / 2.0F * PS179 - 1.0F / 2.0F * PS180 - 1.0F / 2.0F * PS181 + data->P[0][6];
    data->P_Next[1][6] = -PS182 * PS272 + PS183 * PS291 + PS185 * PS284 + PS186 * PS282 + PS187 * PS281 - PS188 * PS283 + PS263 * PS299 - 1.0F / 2.0F * PS293 + (1.0F / 2.0F) * PS294 - 1.0F / 2.0F * PS295 + (1.0F / 2.0F) * PS296 + (1.0F / 2.0F) * PS297 - 1.0F / 2.0F * PS298 + data->P[1][6];
    data->P_Next[2][6] = -PS182 * PS362 + PS183 * PS380 + PS185 * PS373 + PS186 * PS371 + PS187 * PS370 - PS188 * PS372 + PS299 * PS353 - 1.0F / 2.0F * PS381 - 1.0F / 2.0F * PS382 + (1.0F / 2.0F) * PS383 + (1.0F / 2.0F) * PS384 - 1.0F / 2.0F * PS385 + (1.0F / 2.0F) * PS386 + data->P[2][6];
    data->P_Next[3][6] = -PS182 * PS432 + PS183 * PS451 + PS185 * PS444 + PS186 * PS441 + PS187 * PS440 - PS188 * PS442 + PS299 * PS423 + (1.0F / 2.0F) * PS452 - 1.0F / 2.0F * PS453 - 1.0F / 2.0F * PS454 + (1.0F / 2.0F) * PS455 + (1.0F / 2.0F) * PS456 - 1.0F / 2.0F * PS457 + data->P[3][6];
    data->P_Next[4][6] = -PS111 * PS182 * PS480 + PS183 * PS490 + PS185 * PS474 + PS186 * PS477 + PS187 * PS476 - PS188 * PS478 + PS471 * PS499 - PS475 * PS500 - PS484 * PS501 + PS493 * PS502 + PS506;
    data->P_Next[5][6] = -PS163 * PS183 * PS525 + PS185 * PS524 + PS186 * PS520 + PS187 * PS521 - PS188 * PS523 - PS494 * PS529 + PS499 * PS522 - PS500 * PS516 + PS501 * PS526 + PS517 * PS528 + PS530;
    data->P_Next[6][6] = powf(PS182, 2) * PS480 + powf(PS183, 2) * PS525 + powf(PS184, 2) * PS481 + PS499 * PS539 - PS500 * PS540 + PS528 * PS544 - PS543 * (PS243 * PS537 + PS330 * PS535 - PS339 * PS538 - PS355 * PS541 + PS363 * PS542 + PS499 * data->P[2][15] + PS536 * PS59 + data->P[2][6]) + PS545 * (PS237 * PS537 - PS330 * PS538 - PS425 * PS541 + PS433 * PS542 + PS443 * PS535 + PS499 * data->P[3][15] + PS536 * PS69 + data->P[3][6]) + PS546 * (-PS112 * PS541 + PS123 * PS542 + PS49 * PS537 + PS499 * data->P[0][15] + PS535 * PS69 + PS536 * PS83 - PS538 * PS59 + data->P[0][6]) + PS547 * (PS237 * PS535 - PS243 * PS538 + PS249 * PS537 - PS265 * PS541 + PS273 * PS542 + PS49 * PS536 + PS499 * data->P[1][15] + data->P[1][6]) + PS548;
    data->P_Next[0][7] = PS189 * data->P[7][10] + PS190 * data->P[7][11] + PS191 * data->P[7][12] - PS192 * data->P[1][7] - PS193 * data->P[2][7] - PS194 * data->P[3][7] + PS196 * (-PS100 - PS101 + PS195 + PS94 + PS96 + PS98 - PS99) + data->P[0][7];
    data->P_Next[1][7] = -PS190 * data->P[7][12] + PS191 * data->P[7][11] + PS192 * data->P[0][7] - PS193 * data->P[3][7] + PS194 * data->P[2][7] + PS196 * (-PS251 + PS252 - PS253 + PS254 + PS255 - PS256 + PS300) - PS205 * data->P[7][10] + data->P[1][7];
    data->P_Next[2][7] = PS189 * data->P[7][12] - PS191 * data->P[7][10] + PS192 * data->P[3][7] + PS193 * data->P[0][7] - PS194 * data->P[1][7] + PS196 * (-PS341 - PS342 + PS343 + PS344 - PS345 + PS346 + PS387) - PS205 * data->P[7][11] + data->P[2][7];
    data->P_Next[3][7] = -PS189 * data->P[7][11] + PS190 * data->P[7][10] - PS192 * data->P[2][7] + PS193 * data->P[1][7] + PS194 * data->P[0][7] + PS196 * (PS411 - PS412 - PS413 + PS414 + PS415 - PS416 + PS458) - PS205 * data->P[7][12] + data->P[3][7];
    data->P_Next[4][7] = -PS462 * data->P[7][15] + PS463 * data->P[7][14] + PS464 * data->P[7][13] + PS488 * dt + PS507 * data->P[1][7] + PS508 * data->P[0][7] + PS509 * data->P[2][7] - PS510 * data->P[3][7] + data->P[4][7];
    data->P_Next[5][7] = PS489 * data->P[7][14] + PS491 * data->P[7][15] - PS511 * data->P[7][13] + PS531 * data->P[2][7] - PS532 * data->P[0][7] + PS533 * data->P[3][7] - PS534 * data->P[1][7] + data->P[5][7] + dt * (PS165 * PS485 - PS195 * PS513 - PS300 * PS515 + PS387 * PS512 + PS458 * PS514 + PS483 * PS526 - PS487 * PS492 + data->P[4][5]);
    data->P_Next[6][7] = PS499 * data->P[7][15] - PS500 * data->P[7][14] + PS528 * data->P[7][13] - PS543 * data->P[2][7] + PS545 * data->P[3][7] + PS546 * data->P[0][7] + PS547 * data->P[1][7] + data->P[6][7] + dt * (PS184 * PS483 + PS195 * PS536 + PS300 * PS537 - PS387 * PS538 + PS458 * PS535 - PS485 * PS529 + PS487 * PS502 + data->P[4][6]);
    data->P_Next[7][7] = data->P[4][7] * dt + data->P[7][7] + dt * (data->P[4][4] * dt + data->P[4][7]);
    data->P_Next[0][8] = PS189 * data->P[8][10] + PS190 * data->P[8][11] + PS191 * data->P[8][12] - PS192 * data->P[1][8] - PS193 * data->P[2][8] - PS194 * data->P[3][8] + PS196 * (PS154 + PS156 + PS158 - PS159 - PS160 - PS161 + PS197) + data->P[0][8];
    data->P_Next[1][8] = -PS190 * data->P[8][12] + PS191 * data->P[8][11] + PS192 * data->P[0][8] - PS193 * data->P[3][8] + PS194 * data->P[2][8] + PS196 * (-PS285 + PS286 - PS287 + PS288 + PS289 - PS290 + PS301) - PS205 * data->P[8][10] + data->P[1][8];
    data->P_Next[2][8] = PS189 * data->P[8][12] - PS191 * data->P[8][10] + PS192 * data->P[3][8] + PS193 * data->P[0][8] - PS194 * data->P[1][8] + PS196 * (-PS374 - PS375 + PS376 + PS377 - PS378 + PS379 + PS388) - PS205 * data->P[8][11] + data->P[2][8];
    data->P_Next[3][8] = -PS189 * data->P[8][11] + PS190 * data->P[8][10] - PS192 * data->P[2][8] + PS193 * data->P[1][8] + PS194 * data->P[0][8] + PS196 * (PS445 - PS446 - PS447 + PS448 + PS449 - PS450 + PS459) - PS205 * data->P[8][12] + data->P[3][8];
    data->P_Next[4][8] = -PS462 * data->P[8][15] + PS463 * data->P[8][14] + PS464 * data->P[8][13] + PS498 * dt + PS507 * data->P[1][8] + PS508 * data->P[0][8] + PS509 * data->P[2][8] - PS510 * data->P[3][8] + data->P[4][8];
    data->P_Next[5][8] = PS489 * data->P[8][14] + PS491 * data->P[8][15] - PS511 * data->P[8][13] + PS527 * dt + PS531 * data->P[2][8] - PS532 * data->P[0][8] + PS533 * data->P[3][8] - PS534 * data->P[1][8] + data->P[5][8];
    data->P_Next[6][8] = PS499 * data->P[8][15] - PS500 * data->P[8][14] + PS528 * data->P[8][13] - PS543 * data->P[2][8] + PS545 * data->P[3][8] + PS546 * data->P[0][8] + PS547 * data->P[1][8] + data->P[6][8] + dt * (PS184 * PS495 + PS197 * PS536 + PS301 * PS537 - PS388 * PS538 + PS459 * PS535 - PS496 * PS529 + PS497 * PS502 + data->P[5][6]);
    data->P_Next[7][8] = data->P[4][8] * dt + data->P[7][8] + dt * (data->P[4][5] * dt + data->P[5][7]);
    data->P_Next[8][8] = data->P[5][8] * dt + data->P[8][8] + dt * (data->P[5][5] * dt + data->P[5][8]);
    data->P_Next[0][9] = PS189 * data->P[9][10] + PS190 * data->P[9][11] + PS191 * data->P[9][12] - PS192 * data->P[1][9] - PS193 * data->P[2][9] - PS194 * data->P[3][9] + PS196 * (PS174 + PS176 + PS178 - PS179 - PS180 - PS181 + PS198) + data->P[0][9];
    data->P_Next[1][9] = -PS190 * data->P[9][12] + PS191 * data->P[9][11] + PS192 * data->P[0][9] - PS193 * data->P[3][9] + PS194 * data->P[2][9] + PS196 * (-PS293 + PS294 - PS295 + PS296 + PS297 - PS298 + PS302) - PS205 * data->P[9][10] + data->P[1][9];
    data->P_Next[2][9] = PS189 * data->P[9][12] - PS191 * data->P[9][10] + PS192 * data->P[3][9] + PS193 * data->P[0][9] - PS194 * data->P[1][9] + PS196 * (-PS381 - PS382 + PS383 + PS384 - PS385 + PS386 + PS389) - PS205 * data->P[9][11] + data->P[2][9];
    data->P_Next[3][9] = -PS189 * data->P[9][11] + PS190 * data->P[9][10] - PS192 * data->P[2][9] + PS193 * data->P[1][9] + PS194 * data->P[0][9] + PS196 * (PS452 - PS453 - PS454 + PS455 + PS456 - PS457 + PS460) - PS205 * data->P[9][12] + data->P[3][9];
    data->P_Next[4][9] = -PS462 * data->P[9][15] + PS463 * data->P[9][14] + PS464 * data->P[9][13] + PS506 * dt + PS507 * data->P[1][9] + PS508 * data->P[0][9] + PS509 * data->P[2][9] - PS510 * data->P[3][9] + data->P[4][9];
    data->P_Next[5][9] = PS489 * data->P[9][14] + PS491 * data->P[9][15] - PS511 * data->P[9][13] + PS530 * dt + PS531 * data->P[2][9] - PS532 * data->P[0][9] + PS533 * data->P[3][9] - PS534 * data->P[1][9] + data->P[5][9];
    data->P_Next[6][9] = PS499 * data->P[9][15] - PS500 * data->P[9][14] + PS528 * data->P[9][13] - PS543 * data->P[2][9] + PS545 * data->P[3][9] + PS546 * data->P[0][9] + PS547 * data->P[1][9] + PS548 * dt + data->P[6][9];
    data->P_Next[7][9] = data->P[4][9] * dt + data->P[7][9] + dt * (data->P[4][6] * dt + data->P[6][7]);
    data->P_Next[8][9] = data->P[5][9] * dt + data->P[8][9] + dt * (data->P[5][6] * dt + data->P[6][8]);
    data->P_Next[9][9] = data->P[6][9] * dt + data->P[9][9] + dt * (data->P[6][6] * dt + data->P[6][9]);
    data->P_Next[0][10] = PS199 + PS200 + (1.0F / 2.0F) * PS24 - 1.0F / 2.0F * PS27 - 1.0F / 2.0F * PS28 - 1.0F / 2.0F * PS29 + data->P[0][10];
    data->P_Next[1][10] = -PS205 * data->P[10][10] + (1.0F / 2.0F) * PS216 + (1.0F / 2.0F) * PS217 - 1.0F / 2.0F * PS218 + PS303 - PS304 + data->P[1][10];
    data->P_Next[2][10] = PS203 + PS305 - 1.0F / 2.0F * PS325 + (1.0F / 2.0F) * PS326 + (1.0F / 2.0F) * PS327 - 1.0F / 2.0F * PS328 + data->P[2][10];
    data->P_Next[3][10] = -PS201 + PS306 + (1.0F / 2.0F) * PS404 + (1.0F / 2.0F) * PS405 + (1.0F / 2.0F) * PS406 - 1.0F / 2.0F * PS407 + data->P[3][10];
    data->P_Next[4][10] = PS213 * PS465 + PS23 * PS466 + PS324 * PS467 - PS403 * PS468 - PS462 * data->P[10][15] + PS463 * data->P[10][14] + PS464 * data->P[10][13] + data->P[4][10];
    data->P_Next[5][10] = -PS213 * PS515 - PS23 * PS513 + PS324 * PS512 + PS403 * PS514 + PS489 * data->P[10][14] + PS491 * data->P[10][15] - PS511 * data->P[10][13] + data->P[5][10];
    data->P_Next[6][10] = PS213 * PS537 + PS23 * PS536 - PS324 * PS538 + PS403 * PS535 + PS499 * data->P[10][15] - PS500 * data->P[10][14] + PS528 * data->P[10][13] + data->P[6][10];
    data->P_Next[7][10] = PS93 + data->P[7][10];
    data->P_Next[8][10] = PS153 + data->P[8][10];
    data->P_Next[9][10] = PS173 + data->P[9][10];
    data->P_Next[10][10] = data->P[10][10];
    data->P_Next[0][11] = PS201 + PS202 + (1.0F / 2.0F) * PS33 - 1.0F / 2.0F * PS35 - 1.0F / 2.0F * PS36 - 1.0F / 2.0F * PS37 + data->P[0][11];
    data->P_Next[1][11] = -PS204 + (1.0F / 2.0F) * PS228 + (1.0F / 2.0F) * PS230 + (1.0F / 2.0F) * PS231 - 1.0F / 2.0F * PS232 + PS305 + data->P[1][11];
    data->P_Next[2][11] = -PS205 * data->P[11][11] - PS303 + (1.0F / 2.0F) * PS313 + (1.0F / 2.0F) * PS314 - 1.0F / 2.0F * PS315 + PS390 + data->P[2][11];
    data->P_Next[3][11] = PS199 + PS391 - 1.0F / 2.0F * PS399 + (1.0F / 2.0F) * PS400 + (1.0F / 2.0F) * PS401 - 1.0F / 2.0F * PS402 + data->P[3][11];
    data->P_Next[4][11] = PS227 * PS465 + PS31 * PS466 + PS311 * PS467 - PS398 * PS468 - PS462 * data->P[11][15] + PS463 * data->P[11][14] + PS464 * data->P[11][13] + data->P[4][11];
    data->P_Next[5][11] = -PS227 * PS515 - PS31 * PS513 + PS311 * PS512 + PS398 * PS514 + PS489 * data->P[11][14] + PS491 * data->P[11][15] - PS511 * data->P[11][13] + data->P[5][11];
    data->P_Next[6][11] = PS227 * PS537 + PS31 * PS536 - PS311 * PS538 + PS398 * PS535 + PS499 * data->P[11][15] - PS500 * data->P[11][14] + PS528 * data->P[11][13] + data->P[6][11];
    data->P_Next[7][11] = PS95 + data->P[7][11];
    data->P_Next[8][11] = PS155 + data->P[8][11];
    data->P_Next[9][11] = PS175 + data->P[9][11];
    data->P_Next[10][11] = data->P[10][11];
    data->P_Next[11][11] = data->P[11][11];
    data->P_Next[0][12] = PS203 + PS204 + (1.0F / 2.0F) * PS43 - 1.0F / 2.0F * PS44 - 1.0F / 2.0F * PS45 - 1.0F / 2.0F * PS46 + data->P[0][12];
    data->P_Next[1][12] = PS202 - 1.0F / 2.0F * PS222 + (1.0F / 2.0F) * PS223 + (1.0F / 2.0F) * PS224 - 1.0F / 2.0F * PS225 + PS306 + data->P[1][12];
    data->P_Next[2][12] = -PS200 + (1.0F / 2.0F) * PS318 + (1.0F / 2.0F) * PS320 + (1.0F / 2.0F) * PS321 - 1.0F / 2.0F * PS322 + PS391 + data->P[2][12];
    data->P_Next[3][12] = -PS205 * data->P[12][12] + PS304 - PS390 + (1.0F / 2.0F) * PS395 + (1.0F / 2.0F) * PS396 - 1.0F / 2.0F * PS397 + data->P[3][12];
    data->P_Next[4][12] = PS220 * PS465 + PS317 * PS467 - PS394 * PS468 + PS40 * PS466 - PS462 * data->P[12][15] + PS463 * data->P[12][14] + PS464 * data->P[12][13] + data->P[4][12];
    data->P_Next[5][12] = -PS220 * PS515 + PS317 * PS512 + PS394 * PS514 - PS40 * PS513 + PS489 * data->P[12][14] + PS491 * data->P[12][15] - PS511 * data->P[12][13] + data->P[5][12];
    data->P_Next[6][12] = PS220 * PS537 - PS317 * PS538 + PS394 * PS535 + PS40 * PS536 + PS499 * data->P[12][15] - PS500 * data->P[12][14] + PS528 * data->P[12][13] + data->P[6][12];
    data->P_Next[7][12] = PS97 + data->P[7][12];
    data->P_Next[8][12] = PS157 + data->P[8][12];
    data->P_Next[9][12] = PS177 + data->P[9][12];
    data->P_Next[10][12] = data->P[10][12];
    data->P_Next[11][12] = data->P[11][12];
    data->P_Next[12][12] = data->P[12][12];
    data->P_Next[0][13] = (1.0F / 2.0F) * PS124 + (1.0F / 2.0F) * PS125 + (1.0F / 2.0F) * PS126 - 1.0F / 2.0F * PS127 - 1.0F / 2.0F * PS128 - 1.0F / 2.0F * PS129 + data->P[0][13];
    data->P_Next[1][13] = -PS205 * data->P[10][13] + (1.0F / 2.0F) * PS274 - 1.0F / 2.0F * PS275 + (1.0F / 2.0F) * PS276 + (1.0F / 2.0F) * PS277 - 1.0F / 2.0F * PS278 + data->P[1][13];
    data->P_Next[2][13] = -PS205 * data->P[11][13] + (1.0F / 2.0F) * PS364 - 1.0F / 2.0F * PS365 + (1.0F / 2.0F) * PS366 + (1.0F / 2.0F) * PS367 - 1.0F / 2.0F * PS368 + data->P[2][13];
    data->P_Next[3][13] = -PS205 * data->P[12][13] + (1.0F / 2.0F) * PS434 - 1.0F / 2.0F * PS435 + (1.0F / 2.0F) * PS436 + (1.0F / 2.0F) * PS437 - 1.0F / 2.0F * PS438 + data->P[3][13];
    data->P_Next[4][13] = PS469;
    data->P_Next[5][13] = PS517;
    data->P_Next[6][13] = PS544;
    data->P_Next[7][13] = PS487 + data->P[7][13];
    data->P_Next[8][13] = PS497 + data->P[8][13];
    data->P_Next[9][13] = PS505 + data->P[9][13];
    data->P_Next[10][13] = data->P[10][13];
    data->P_Next[11][13] = data->P[11][13];
    data->P_Next[12][13] = data->P[12][13];
    data->P_Next[13][13] = data->P[13][13];
    data->P_Next[0][14] = (1.0F / 2.0F) * PS113 + (1.0F / 2.0F) * PS114 + (1.0F / 2.0F) * PS115 - 1.0F / 2.0F * PS116 - 1.0F / 2.0F * PS117 - 1.0F / 2.0F * PS118 + data->P[0][14];
    data->P_Next[1][14] = -PS205 * data->P[10][14] + (1.0F / 2.0F) * PS266 - 1.0F / 2.0F * PS267 + (1.0F / 2.0F) * PS268 + (1.0F / 2.0F) * PS269 - 1.0F / 2.0F * PS270 + data->P[1][14];
    data->P_Next[2][14] = -PS205 * data->P[11][14] + (1.0F / 2.0F) * PS356 - 1.0F / 2.0F * PS357 + (1.0F / 2.0F) * PS358 + (1.0F / 2.0F) * PS359 - 1.0F / 2.0F * PS360 + data->P[2][14];
    data->P_Next[3][14] = -PS205 * data->P[12][14] + (1.0F / 2.0F) * PS426 - 1.0F / 2.0F * PS427 + (1.0F / 2.0F) * PS428 + (1.0F / 2.0F) * PS429 - 1.0F / 2.0F * PS430 + data->P[3][14];
    data->P_Next[4][14] = PS475;
    data->P_Next[5][14] = PS516;
    data->P_Next[6][14] = PS540;
    data->P_Next[7][14] = PS485 + data->P[7][14];
    data->P_Next[8][14] = PS496 + data->P[8][14];
    data->P_Next[9][14] = PS504 + data->P[9][14];
    data->P_Next[10][14] = data->P[10][14];
    data->P_Next[11][14] = data->P[11][14];
    data->P_Next[12][14] = data->P[12][14];
    data->P_Next[13][14] = data->P[13][14];
    data->P_Next[14][14] = data->P[14][14];
    data->P_Next[0][15] = (1.0F / 2.0F) * PS104 + (1.0F / 2.0F) * PS105 + (1.0F / 2.0F) * PS106 - 1.0F / 2.0F * PS107 - 1.0F / 2.0F * PS108 - 1.0F / 2.0F * PS109 + data->P[0][15];
    data->P_Next[1][15] = -PS205 * data->P[10][15] + (1.0F / 2.0F) * PS258 - 1.0F / 2.0F * PS259 + (1.0F / 2.0F) * PS260 + (1.0F / 2.0F) * PS261 - 1.0F / 2.0F * PS262 + data->P[1][15];
    data->P_Next[2][15] = -PS205 * data->P[11][15] + (1.0F / 2.0F) * PS348 - 1.0F / 2.0F * PS349 + (1.0F / 2.0F) * PS350 + (1.0F / 2.0F) * PS351 - 1.0F / 2.0F * PS352 + data->P[2][15];
    data->P_Next[3][15] = -PS205 * data->P[12][15] + (1.0F / 2.0F) * PS418 - 1.0F / 2.0F * PS419 + (1.0F / 2.0F) * PS420 + (1.0F / 2.0F) * PS421 - 1.0F / 2.0F * PS422 + data->P[3][15];
    data->P_Next[4][15] = PS471;
    data->P_Next[5][15] = PS522;
    data->P_Next[6][15] = PS539;
    data->P_Next[7][15] = PS483 + data->P[7][15];
    data->P_Next[8][15] = PS495 + data->P[8][15];
    data->P_Next[9][15] = PS503 + data->P[9][15];
    data->P_Next[10][15] = data->P[10][15];
    data->P_Next[11][15] = data->P[11][15];
    data->P_Next[12][15] = data->P[12][15];
    data->P_Next[13][15] = data->P[13][15];
    data->P_Next[14][15] = data->P[14][15];
    data->P_Next[15][15] = data->P[15][15];
    data->P_Next[0][16] = PS189 * data->P[10][16] + PS190 * data->P[11][16] + PS191 * data->P[12][16] - PS192 * data->P[1][16] - PS193 * data->P[2][16] - PS194 * data->P[3][16] + data->P[0][16];
    data->P_Next[1][16] = -PS190 * data->P[12][16] + PS191 * data->P[11][16] + PS192 * data->P[0][16] - PS193 * data->P[3][16] + PS194 * data->P[2][16] - PS205 * data->P[10][16] + data->P[1][16];
    data->P_Next[2][16] = PS189 * data->P[12][16] - PS191 * data->P[10][16] + PS192 * data->P[3][16] + PS193 * data->P[0][16] - PS194 * data->P[1][16] - PS205 * data->P[11][16] + data->P[2][16];
    data->P_Next[3][16] = -PS189 * data->P[11][16] + PS190 * data->P[10][16] - PS192 * data->P[2][16] + PS193 * data->P[1][16] + PS194 * data->P[0][16] - PS205 * data->P[12][16] + data->P[3][16];
    data->P_Next[4][16] = -PS462 * data->P[15][16] + PS463 * data->P[14][16] + PS464 * data->P[13][16] + PS507 * data->P[1][16] + PS508 * data->P[0][16] + PS509 * data->P[2][16] - PS510 * data->P[3][16] + data->P[4][16];
    data->P_Next[5][16] = PS489 * data->P[14][16] + PS491 * data->P[15][16] - PS511 * data->P[13][16] + PS531 * data->P[2][16] - PS532 * data->P[0][16] + PS533 * data->P[3][16] - PS534 * data->P[1][16] + data->P[5][16];
    data->P_Next[6][16] = PS499 * data->P[15][16] - PS500 * data->P[14][16] + PS528 * data->P[13][16] - PS543 * data->P[2][16] + PS545 * data->P[3][16] + PS546 * data->P[0][16] + PS547 * data->P[1][16] + data->P[6][16];
    data->P_Next[7][16] = data->P[4][16] * dt + data->P[7][16];
    data->P_Next[8][16] = data->P[5][16] * dt + data->P[8][16];
    data->P_Next[9][16] = data->P[6][16] * dt + data->P[9][16];
    data->P_Next[10][16] = data->P[10][16];
    data->P_Next[11][16] = data->P[11][16];
    data->P_Next[12][16] = data->P[12][16];
    data->P_Next[13][16] = data->P[13][16];
    data->P_Next[14][16] = data->P[14][16];
    data->P_Next[15][16] = data->P[15][16];
    data->P_Next[16][16] = data->P[16][16];
    data->P_Next[0][17] = PS189 * data->P[10][17] + PS190 * data->P[11][17] + PS191 * data->P[12][17] - PS192 * data->P[1][17] - PS193 * data->P[2][17] - PS194 * data->P[3][17] + data->P[0][17];
    data->P_Next[1][17] = -PS190 * data->P[12][17] + PS191 * data->P[11][17] + PS192 * data->P[0][17] - PS193 * data->P[3][17] + PS194 * data->P[2][17] - PS205 * data->P[10][17] + data->P[1][17];
    data->P_Next[2][17] = PS189 * data->P[12][17] - PS191 * data->P[10][17] + PS192 * data->P[3][17] + PS193 * data->P[0][17] - PS194 * data->P[1][17] - PS205 * data->P[11][17] + data->P[2][17];
    data->P_Next[3][17] = -PS189 * data->P[11][17] + PS190 * data->P[10][17] - PS192 * data->P[2][17] + PS193 * data->P[1][17] + PS194 * data->P[0][17] - PS205 * data->P[12][17] + data->P[3][17];
    data->P_Next[4][17] = -PS462 * data->P[15][17] + PS463 * data->P[14][17] + PS464 * data->P[13][17] + PS507 * data->P[1][17] + PS508 * data->P[0][17] + PS509 * data->P[2][17] - PS510 * data->P[3][17] + data->P[4][17];
    data->P_Next[5][17] = PS489 * data->P[14][17] + PS491 * data->P[15][17] - PS511 * data->P[13][17] + PS531 * data->P[2][17] - PS532 * data->P[0][17] + PS533 * data->P[3][17] - PS534 * data->P[1][17] + data->P[5][17];
    data->P_Next[6][17] = PS499 * data->P[15][17] - PS500 * data->P[14][17] + PS528 * data->P[13][17] - PS543 * data->P[2][17] + PS545 * data->P[3][17] + PS546 * data->P[0][17] + PS547 * data->P[1][17] + data->P[6][17];
    data->P_Next[7][17] = data->P[4][17] * dt + data->P[7][17];
    data->P_Next[8][17] = data->P[5][17] * dt + data->P[8][17];
    data->P_Next[9][17] = data->P[6][17] * dt + data->P[9][17];
    data->P_Next[10][17] = data->P[10][17];
    data->P_Next[11][17] = data->P[11][17];
    data->P_Next[12][17] = data->P[12][17];
    data->P_Next[13][17] = data->P[13][17];
    data->P_Next[14][17] = data->P[14][17];
    data->P_Next[15][17] = data->P[15][17];
    data->P_Next[16][17] = data->P[16][17];
    data->P_Next[17][17] = data->P[17][17];
    data->P_Next[0][18] = PS189 * data->P[10][18] + PS190 * data->P[11][18] + PS191 * data->P[12][18] - PS192 * data->P[1][18] - PS193 * data->P[2][18] - PS194 * data->P[3][18] + data->P[0][18];
    data->P_Next[1][18] = -PS190 * data->P[12][18] + PS191 * data->P[11][18] + PS192 * data->P[0][18] - PS193 * data->P[3][18] + PS194 * data->P[2][18] - PS205 * data->P[10][18] + data->P[1][18];
    data->P_Next[2][18] = PS189 * data->P[12][18] - PS191 * data->P[10][18] + PS192 * data->P[3][18] + PS193 * data->P[0][18] - PS194 * data->P[1][18] - PS205 * data->P[11][18] + data->P[2][18];
    data->P_Next[3][18] = -PS189 * data->P[11][18] + PS190 * data->P[10][18] - PS192 * data->P[2][18] + PS193 * data->P[1][18] + PS194 * data->P[0][18] - PS205 * data->P[12][18] + data->P[3][18];
    data->P_Next[4][18] = -PS462 * data->P[15][18] + PS463 * data->P[14][18] + PS464 * data->P[13][18] + PS507 * data->P[1][18] + PS508 * data->P[0][18] + PS509 * data->P[2][18] - PS510 * data->P[3][18] + data->P[4][18];
    data->P_Next[5][18] = PS489 * data->P[14][18] + PS491 * data->P[15][18] - PS511 * data->P[13][18] + PS531 * data->P[2][18] - PS532 * data->P[0][18] + PS533 * data->P[3][18] - PS534 * data->P[1][18] + data->P[5][18];
    data->P_Next[6][18] = PS499 * data->P[15][18] - PS500 * data->P[14][18] + PS528 * data->P[13][18] - PS543 * data->P[2][18] + PS545 * data->P[3][18] + PS546 * data->P[0][18] + PS547 * data->P[1][18] + data->P[6][18];
    data->P_Next[7][18] = data->P[4][18] * dt + data->P[7][18];
    data->P_Next[8][18] = data->P[5][18] * dt + data->P[8][18];
    data->P_Next[9][18] = data->P[6][18] * dt + data->P[9][18];
    data->P_Next[10][18] = data->P[10][18];
    data->P_Next[11][18] = data->P[11][18];
    data->P_Next[12][18] = data->P[12][18];
    data->P_Next[13][18] = data->P[13][18];
    data->P_Next[14][18] = data->P[14][18];
    data->P_Next[15][18] = data->P[15][18];
    data->P_Next[16][18] = data->P[16][18];
    data->P_Next[17][18] = data->P[17][18];
    data->P_Next[18][18] = data->P[18][18];
    data->P_Next[0][19] = PS189 * data->P[10][19] + PS190 * data->P[11][19] + PS191 * data->P[12][19] - PS192 * data->P[1][19] - PS193 * data->P[2][19] - PS194 * data->P[3][19] + data->P[0][19];
    data->P_Next[1][19] = -PS190 * data->P[12][19] + PS191 * data->P[11][19] + PS192 * data->P[0][19] - PS193 * data->P[3][19] + PS194 * data->P[2][19] - PS205 * data->P[10][19] + data->P[1][19];
    data->P_Next[2][19] = PS189 * data->P[12][19] - PS191 * data->P[10][19] + PS192 * data->P[3][19] + PS193 * data->P[0][19] - PS194 * data->P[1][19] - PS205 * data->P[11][19] + data->P[2][19];
    data->P_Next[3][19] = -PS189 * data->P[11][19] + PS190 * data->P[10][19] - PS192 * data->P[2][19] + PS193 * data->P[1][19] + PS194 * data->P[0][19] - PS205 * data->P[12][19] + data->P[3][19];
    data->P_Next[4][19] = -PS462 * data->P[15][19] + PS463 * data->P[14][19] + PS464 * data->P[13][19] + PS507 * data->P[1][19] + PS508 * data->P[0][19] + PS509 * data->P[2][19] - PS510 * data->P[3][19] + data->P[4][19];
    data->P_Next[5][19] = PS489 * data->P[14][19] + PS491 * data->P[15][19] - PS511 * data->P[13][19] + PS531 * data->P[2][19] - PS532 * data->P[0][19] + PS533 * data->P[3][19] - PS534 * data->P[1][19] + data->P[5][19];
    data->P_Next[6][19] = PS499 * data->P[15][19] - PS500 * data->P[14][19] + PS528 * data->P[13][19] - PS543 * data->P[2][19] + PS545 * data->P[3][19] + PS546 * data->P[0][19] + PS547 * data->P[1][19] + data->P[6][19];
    data->P_Next[7][19] = data->P[4][19] * dt + data->P[7][19];
    data->P_Next[8][19] = data->P[5][19] * dt + data->P[8][19];
    data->P_Next[9][19] = data->P[6][19] * dt + data->P[9][19];
    data->P_Next[10][19] = data->P[10][19];
    data->P_Next[11][19] = data->P[11][19];
    data->P_Next[12][19] = data->P[12][19];
    data->P_Next[13][19] = data->P[13][19];
    data->P_Next[14][19] = data->P[14][19];
    data->P_Next[15][19] = data->P[15][19];
    data->P_Next[16][19] = data->P[16][19];
    data->P_Next[17][19] = data->P[17][19];
    data->P_Next[18][19] = data->P[18][19];
    data->P_Next[19][19] = data->P[19][19];
    data->P_Next[0][20] = PS189 * data->P[10][20] + PS190 * data->P[11][20] + PS191 * data->P[12][20] - PS192 * data->P[1][20] - PS193 * data->P[2][20] - PS194 * data->P[3][20] + data->P[0][20];
    data->P_Next[1][20] = -PS190 * data->P[12][20] + PS191 * data->P[11][20] + PS192 * data->P[0][20] - PS193 * data->P[3][20] + PS194 * data->P[2][20] - PS205 * data->P[10][20] + data->P[1][20];
    data->P_Next[2][20] = PS189 * data->P[12][20] - PS191 * data->P[10][20] + PS192 * data->P[3][20] + PS193 * data->P[0][20] - PS194 * data->P[1][20] - PS205 * data->P[11][20] + data->P[2][20];
    data->P_Next[3][20] = -PS189 * data->P[11][20] + PS190 * data->P[10][20] - PS192 * data->P[2][20] + PS193 * data->P[1][20] + PS194 * data->P[0][20] - PS205 * data->P[12][20] + data->P[3][20];
    data->P_Next[4][20] = -PS462 * data->P[15][20] + PS463 * data->P[14][20] + PS464 * data->P[13][20] + PS507 * data->P[1][20] + PS508 * data->P[0][20] + PS509 * data->P[2][20] - PS510 * data->P[3][20] + data->P[4][20];
    data->P_Next[5][20] = PS489 * data->P[14][20] + PS491 * data->P[15][20] - PS511 * data->P[13][20] + PS531 * data->P[2][20] - PS532 * data->P[0][20] + PS533 * data->P[3][20] - PS534 * data->P[1][20] + data->P[5][20];
    data->P_Next[6][20] = PS499 * data->P[15][20] - PS500 * data->P[14][20] + PS528 * data->P[13][20] - PS543 * data->P[2][20] + PS545 * data->P[3][20] + PS546 * data->P[0][20] + PS547 * data->P[1][20] + data->P[6][20];
    data->P_Next[7][20] = data->P[4][20] * dt + data->P[7][20];
    data->P_Next[8][20] = data->P[5][20] * dt + data->P[8][20];
    data->P_Next[9][20] = data->P[6][20] * dt + data->P[9][20];
    data->P_Next[10][20] = data->P[10][20];
    data->P_Next[11][20] = data->P[11][20];
    data->P_Next[12][20] = data->P[12][20];
    data->P_Next[13][20] = data->P[13][20];
    data->P_Next[14][20] = data->P[14][20];
    data->P_Next[15][20] = data->P[15][20];
    data->P_Next[16][20] = data->P[16][20];
    data->P_Next[17][20] = data->P[17][20];
    data->P_Next[18][20] = data->P[18][20];
    data->P_Next[19][20] = data->P[19][20];
    data->P_Next[20][20] = data->P[20][20];
    data->P_Next[0][21] = PS189 * data->P[10][21] + PS190 * data->P[11][21] + PS191 * data->P[12][21] - PS192 * data->P[1][21] - PS193 * data->P[2][21] - PS194 * data->P[3][21] + data->P[0][21];
    data->P_Next[1][21] = -PS190 * data->P[12][21] + PS191 * data->P[11][21] + PS192 * data->P[0][21] - PS193 * data->P[3][21] + PS194 * data->P[2][21] - PS205 * data->P[10][21] + data->P[1][21];
    data->P_Next[2][21] = PS189 * data->P[12][21] - PS191 * data->P[10][21] + PS192 * data->P[3][21] + PS193 * data->P[0][21] - PS194 * data->P[1][21] - PS205 * data->P[11][21] + data->P[2][21];
    data->P_Next[3][21] = -PS189 * data->P[11][21] + PS190 * data->P[10][21] - PS192 * data->P[2][21] + PS193 * data->P[1][21] + PS194 * data->P[0][21] - PS205 * data->P[12][21] + data->P[3][21];
    data->P_Next[4][21] = -PS462 * data->P[15][21] + PS463 * data->P[14][21] + PS464 * data->P[13][21] + PS507 * data->P[1][21] + PS508 * data->P[0][21] + PS509 * data->P[2][21] - PS510 * data->P[3][21] + data->P[4][21];
    data->P_Next[5][21] = PS489 * data->P[14][21] + PS491 * data->P[15][21] - PS511 * data->P[13][21] + PS531 * data->P[2][21] - PS532 * data->P[0][21] + PS533 * data->P[3][21] - PS534 * data->P[1][21] + data->P[5][21];
    data->P_Next[6][21] = PS499 * data->P[15][21] - PS500 * data->P[14][21] + PS528 * data->P[13][21] - PS543 * data->P[2][21] + PS545 * data->P[3][21] + PS546 * data->P[0][21] + PS547 * data->P[1][21] + data->P[6][21];
    data->P_Next[7][21] = data->P[4][21] * dt + data->P[7][21];
    data->P_Next[8][21] = data->P[5][21] * dt + data->P[8][21];
    data->P_Next[9][21] = data->P[6][21] * dt + data->P[9][21];
    data->P_Next[10][21] = data->P[10][21];
    data->P_Next[11][21] = data->P[11][21];
    data->P_Next[12][21] = data->P[12][21];
    data->P_Next[13][21] = data->P[13][21];
    data->P_Next[14][21] = data->P[14][21];
    data->P_Next[15][21] = data->P[15][21];
    data->P_Next[16][21] = data->P[16][21];
    data->P_Next[17][21] = data->P[17][21];
    data->P_Next[18][21] = data->P[18][21];
    data->P_Next[19][21] = data->P[19][21];
    data->P_Next[20][21] = data->P[20][21];
    data->P_Next[21][21] = data->P[21][21];

    memcpy(data->P, data->P_Next, sizeof(data->P));
}

void ekf_fuse(ekf_data_t *data, ekf_inputs_t *inputs)
{
    const float q_w = data->state.orientation.w;
    const float q_x = data->state.orientation.x;
    const float q_y = data->state.orientation.y;
    const float q_z = data->state.orientation.z;
    const float mag_n = data->state.mag_ned.x;
    const float mag_e = data->state.mag_ned.y;
    const float mag_d = data->state.mag_ned.z;
    const float R_GPS = data->config.gpsVariance;
    const float R_BARO = data->config.baroVariance;
    const float R_MAG = data->config.magVariance;

    const float HS0 = mag_d * q_y;
    const float HS1 = mag_d * q_z;
    const float HS2 = mag_e * q_y;
    const float HS3 = mag_d * q_w;
    const float HS4 = mag_e * q_x;
    const float HS5 = mag_n * q_y;
    const float HS6 = mag_d * q_x;
    const float HS7 = mag_e * q_w;
    const float HS8 = mag_n * q_z;
    const float HS9 = 2 * powf(q_y, 2);
    const float HS10 = 2 * powf(q_z, 2) - 1;
    const float HS11 = q_w * q_z;
    const float HS12 = q_w * q_y;
    const float HS13 = -HS8;
    const float HS14 = mag_n * q_x;
    const float HS15 = mag_n * q_w;
    const float HS16 = mag_e * q_z;
    const float HS17 = 2 * powf(q_x, 2);
    const float HS18 = q_w * q_x;

    data->H[0][0] = 0;
    data->H[1][0] = 0;
    data->H[2][0] = 0;
    data->H[3][0] = 0;
    data->H[4][0] = -2 * HS0 + 2 * mag_e * q_z;
    data->H[5][0] = 2 * HS13 + 2 * HS6;
    data->H[6][0] = -2 * HS4 + 2 * mag_n * q_y;
    data->H[0][1] = 0;
    data->H[1][1] = 0;
    data->H[2][1] = 0;
    data->H[3][1] = 0;
    data->H[4][1] = 2 * HS1 + 2 * HS2;
    data->H[5][1] = 2 * HS3 - 4 * HS4 + 2 * HS5;
    data->H[6][1] = -2 * HS13 - 4 * HS6 - 2 * HS7;
    data->H[0][2] = 0;
    data->H[1][2] = 0;
    data->H[2][2] = 0;
    data->H[3][2] = 0;
    data->H[4][2] = -2 * HS3 + 2 * HS4 - 4 * HS5;
    data->H[5][2] = 2 * HS1 + 2 * HS14;
    data->H[6][2] = -4 * HS0 + 2 * HS15 + 2 * HS16;
    data->H[0][3] = 0;
    data->H[1][3] = 0;
    data->H[2][3] = 0;
    data->H[3][3] = 0;
    data->H[4][3] = 2 * HS6 + 2 * HS7 - 4 * HS8;
    data->H[5][3] = 2 * HS0 - 2 * HS15 - 4 * HS16;
    data->H[6][3] = 2 * HS14 + 2 * HS2;
    data->H[0][4] = 0;
    data->H[1][4] = 0;
    data->H[2][4] = 0;
    data->H[3][4] = 0;
    data->H[4][4] = 0;
    data->H[5][4] = 0;
    data->H[6][4] = 0;
    data->H[0][5] = 0;
    data->H[1][5] = 0;
    data->H[2][5] = 0;
    data->H[3][5] = 0;
    data->H[4][5] = 0;
    data->H[5][5] = 0;
    data->H[6][5] = 0;
    data->H[0][6] = 0;
    data->H[1][6] = 0;
    data->H[2][6] = 0;
    data->H[3][6] = 0;
    data->H[4][6] = 0;
    data->H[5][6] = 0;
    data->H[6][6] = 0;
    data->H[0][7] = 1;
    data->H[1][7] = 0;
    data->H[2][7] = 0;
    data->H[3][7] = 0;
    data->H[4][7] = 0;
    data->H[5][7] = 0;
    data->H[6][7] = 0;
    data->H[0][8] = 0;
    data->H[1][8] = 1;
    data->H[2][8] = 0;
    data->H[3][8] = 0;
    data->H[4][8] = 0;
    data->H[5][8] = 0;
    data->H[6][8] = 0;
    data->H[0][9] = 0;
    data->H[1][9] = 0;
    data->H[2][9] = 1;
    data->H[3][9] = 1;
    data->H[4][9] = 0;
    data->H[5][9] = 0;
    data->H[6][9] = 0;
    data->H[0][10] = 0;
    data->H[1][10] = 0;
    data->H[2][10] = 0;
    data->H[3][10] = 0;
    data->H[4][10] = 0;
    data->H[5][10] = 0;
    data->H[6][10] = 0;
    data->H[0][11] = 0;
    data->H[1][11] = 0;
    data->H[2][11] = 0;
    data->H[3][11] = 0;
    data->H[4][11] = 0;
    data->H[5][11] = 0;
    data->H[6][11] = 0;
    data->H[0][12] = 0;
    data->H[1][12] = 0;
    data->H[2][12] = 0;
    data->H[3][12] = 0;
    data->H[4][12] = 0;
    data->H[5][12] = 0;
    data->H[6][12] = 0;
    data->H[0][13] = 0;
    data->H[1][13] = 0;
    data->H[2][13] = 0;
    data->H[3][13] = 0;
    data->H[4][13] = 0;
    data->H[5][13] = 0;
    data->H[6][13] = 0;
    data->H[0][14] = 0;
    data->H[1][14] = 0;
    data->H[2][14] = 0;
    data->H[3][14] = 0;
    data->H[4][14] = 0;
    data->H[5][14] = 0;
    data->H[6][14] = 0;
    data->H[0][15] = 0;
    data->H[1][15] = 0;
    data->H[2][15] = 0;
    data->H[3][15] = 0;
    data->H[4][15] = 0;
    data->H[5][15] = 0;
    data->H[6][15] = 0;
    data->H[0][16] = 0;
    data->H[1][16] = 0;
    data->H[2][16] = 0;
    data->H[3][16] = 0;
    data->H[4][16] = -HS10 - HS9;
    data->H[5][16] = -2 * HS11 + 2 * q_x * q_y;
    data->H[6][16] = 2 * HS12 + 2 * q_x * q_z;
    data->H[0][17] = 0;
    data->H[1][17] = 0;
    data->H[2][17] = 0;
    data->H[3][17] = 0;
    data->H[4][17] = 2 * HS11 + 2 * q_x * q_y;
    data->H[5][17] = -HS10 - HS17;
    data->H[6][17] = -2 * HS18 + 2 * q_y * q_z;
    data->H[0][18] = 0;
    data->H[1][18] = 0;
    data->H[2][18] = 0;
    data->H[3][18] = 0;
    data->H[4][18] = -2 * HS12 + 2 * q_x * q_z;
    data->H[5][18] = 2 * HS18 + 2 * q_y * q_z;
    data->H[6][18] = -HS17 - HS9 + 1;
    data->H[0][19] = 0;
    data->H[1][19] = 0;
    data->H[2][19] = 0;
    data->H[3][19] = 0;
    data->H[4][19] = 1;
    data->H[5][19] = 0;
    data->H[6][19] = 0;
    data->H[0][20] = 0;
    data->H[1][20] = 0;
    data->H[2][20] = 0;
    data->H[3][20] = 0;
    data->H[4][20] = 0;
    data->H[5][20] = 1;
    data->H[6][20] = 0;
    data->H[0][21] = 0;
    data->H[1][21] = 0;
    data->H[2][21] = 0;
    data->H[3][21] = 0;
    data->H[4][21] = 0;
    data->H[5][21] = 0;
    data->H[6][21] = 1;

    const float KS0 = 1.0F / (data->P[7][7] + R_GPS);
    const float KS1 = 1.0F / (data->P[8][8] + R_GPS);
    const float KS2 = 1.0F / (data->P[9][9] + R_GPS);
    const float KS3 = 1.0F / (data->P[9][9] + R_BARO);
    const float KS4 = q_w * q_z;
    const float KS5 = q_x * q_y;
    const float KS6 = KS4 + KS5;
    const float KS7 = 2 * data->P[0][17];
    const float KS8 = mag_d * q_z;
    const float KS9 = mag_e * q_y;
    const float KS10 = KS8 + KS9;
    const float KS11 = 2 * data->P[0][1];
    const float KS12 = mag_d * q_y;
    const float KS13 = mag_e * q_z;
    const float KS14 = KS12 - KS13;
    const float KS15 = 2 * data->P[0][0];
    const float KS16 = q_w * q_y;
    const float KS17 = q_x * q_z;
    const float KS18 = KS16 - KS17;
    const float KS19 = 2 * data->P[0][18];
    const float KS20 = powf(q_y, 2);
    const float KS21 = 2 * KS20;
    const float KS22 = powf(q_z, 2);
    const float KS23 = 2 * KS22 - 1;
    const float KS24 = KS21 + KS23;
    const float KS25 = mag_d * q_x;
    const float KS26 = mag_e * q_w;
    const float KS27 = mag_n * q_z;
    const float KS28 = KS25 + KS26 - 2 * KS27;
    const float KS29 = 2 * data->P[0][3];
    const float KS30 = mag_d * q_w;
    const float KS31 = mag_e * q_x;
    const float KS32 = mag_n * q_y;
    const float KS33 = KS30 - KS31 + 2 * KS32;
    const float KS34 = 2 * data->P[0][2];
    const float KS35 = 2 * data->P[16][19];
    const float KS36 = 4 * data->P[16][16];
    const float KS37 = KS20 * KS36;
    const float KS38 = KS22 * KS36;
    const float KS39 = 4 * data->P[16][19];
    const float KS40 = powf(q_y, 4);
    const float KS41 = powf(q_z, 4);
    const float KS42 = powf(q_z, 3);
    const float KS43 = 8 * KS42;
    const float KS44 = KS43 * mag_d;
    const float KS45 = powf(q_y, 3);
    const float KS46 = 8 * KS45;
    const float KS47 = KS46 * mag_e;
    const float KS48 = 8 * KS32;
    const float KS49 = KS48 * data->P[2][16];
    const float KS50 = 8 * KS27;
    const float KS51 = KS50 * data->P[3][16];
    const float KS52 = KS43 * data->P[16][17] * q_w;
    const float KS53 = 4 * KS30;
    const float KS54 = 4 * KS12;
    const float KS55 = 4 * KS16;
    const float KS56 = KS55 * data->P[16][18];
    const float KS57 = 4 * KS25;
    const float KS58 = 4 * KS8;
    const float KS59 = 4 * KS26;
    const float KS60 = 4 * KS31;
    const float KS61 = 4 * KS9;
    const float KS62 = 4 * KS13;
    const float KS63 = 4 * KS4;
    const float KS64 = KS63 * data->P[16][17];
    const float KS65 = 4 * KS5;
    const float KS66 = 4 * KS17;
    const float KS67 = 4 * data->P[0][0];
    const float KS68 = powf(mag_d, 2);
    const float KS69 = KS20 * KS68;
    const float KS70 = powf(mag_e, 2);
    const float KS71 = KS22 * KS67;
    const float KS72 = powf(q_w, 2);
    const float KS73 = 4 * data->P[17][17];
    const float KS74 = KS22 * KS73;
    const float KS75 = powf(q_x, 2);
    const float KS76 = KS73 * KS75;
    const float KS77 = 4 * data->P[18][18];
    const float KS78 = KS20 * KS77;
    const float KS79 = KS75 * KS77;
    const float KS80 = 4 * data->P[1][1];
    const float KS81 = KS68 * KS80;
    const float KS82 = KS20 * KS80;
    const float KS83 = 4 * data->P[2][2];
    const float KS84 = KS68 * KS83;
    const float KS85 = KS75 * KS83;
    const float KS86 = 4 * data->P[3][3];
    const float KS87 = KS68 * KS75;
    const float KS88 = KS72 * KS86;
    const float KS89 = KS46 * data->P[16][18] * q_w;
    const float KS90 = 8 * KS22;
    const float KS91 = 16 * mag_n;
    const float KS92 = powf(mag_n, 2);
    const float KS93 = 16 * KS92;
    const float KS94 = KS22 * data->P[3][3];
    const float KS95 = KS22 * KS91;
    const float KS96 = data->P[1][3] * mag_d;
    const float KS97 = data->P[0][3] * mag_e;
    const float KS98 = KS95 * KS97;
    const float KS99 = KS20 * KS91;
    const float KS100 = data->P[1][2] * mag_e;
    const float KS101 = 16 * KS22;
    const float KS102 = mag_n * q_w;
    const float KS103 = KS102 * data->P[3][17];
    const float KS104 = 16 * KS20;
    const float KS105 = mag_n * q_x;
    const float KS106 = KS105 * data->P[2][17];
    const float KS107 = KS101 * data->P[3][18];
    const float KS108 = 8 * KS20;
    const float KS109 = mag_d * mag_e;
    const float KS110 = KS109 * data->P[0][1];
    const float KS111 = 8 * KS72;
    const float KS112 = KS109 * data->P[2][3];
    const float KS113 = 8 * KS25;
    const float KS114 = KS113 * KS20;
    const float KS115 = KS114 * data->P[3][16];
    const float KS116 = KS90 * data->P[3][16];
    const float KS117 = KS8 * data->P[1][16];
    const float KS118 = KS8 * data->P[2][17];
    const float KS119 = KS108 * KS26;
    const float KS120 = KS119 * data->P[1][18];
    const float KS121 = KS119 * data->P[3][16];
    const float KS122 = 8 * KS31;
    const float KS123 = KS122 * KS20;
    const float KS124 = KS90 * data->P[2][16];
    const float KS125 = KS124 * KS31;
    const float KS126 = KS9 * data->P[1][16];
    const float KS127 = KS111 * data->P[3][18];
    const float KS128 = 8 * KS13;
    const float KS129 = KS128 * data->P[0][16];
    const float KS130 = q_w * q_x;
    const float KS131 = KS130 * data->P[17][18];
    const float KS132 = KS108 * KS131;
    const float KS133 = 8 * KS68;
    const float KS134 = KS130 * data->P[2][3];
    const float KS135 = KS4 * data->P[16][17];
    const float KS136 = KS108 * KS135;
    const float KS137 = KS4 * data->P[1][2];
    const float KS138 = KS133 * KS137;
    const float KS139 = KS5 * data->P[0][3];
    const float KS140 = KS133 * KS139;
    const float KS141 = q_y * q_z;
    const float KS142 = KS141 * data->P[0][1];
    const float KS143 = KS141 * data->P[17][18];
    const float KS144 = 8 * KS75;
    const float KS145 = KS108 * KS30;
    const float KS146 = KS30 * data->P[1][17];
    const float KS147 = KS146 * KS90;
    const float KS148 = KS124 * KS30;
    const float KS149 = KS25 * KS90;
    const float KS150 = KS12 * KS90;
    const float KS151 = 8 * KS12;
    const float KS152 = KS151 * data->P[2][18];
    const float KS153 = KS151 * KS75;
    const float KS154 = KS153 * data->P[3][17];
    const float KS155 = KS8 * data->P[3][18];
    const float KS156 = KS26 * data->P[0][17];
    const float KS157 = KS122 * data->P[1][17];
    const float KS158 = KS144 * KS9;
    const float KS159 = KS128 * data->P[2][18];
    const float KS160 = KS159 * KS75;
    const float KS161 = KS128 * data->P[3][17];
    const float KS162 = KS131 * KS90;
    const float KS163 = 8 * KS70;
    const float KS164 = KS133 * KS16;
    const float KS165 = KS16 * data->P[16][18];
    const float KS166 = KS165 * KS90;
    const float KS167 = KS16 * data->P[1][3];
    const float KS168 = KS163 * KS167;
    const float KS169 = KS4 * data->P[0][3];
    const float KS170 = KS5 * data->P[1][2];
    const float KS171 = KS17 * data->P[0][2];
    const float KS172 = KS163 * KS171;
    const float KS173 = KS17 * data->P[1][3];
    const float KS174 = KS143 * KS144;
    const float KS175 = data->P[0][2] * mag_d;
    const float KS176 = KS175 * KS99;
    const float KS177 = KS102 * data->P[2][18];
    const float KS178 = KS141 * data->P[2][3];
    const float KS179 = 16 * KS8;
    const float KS180 = KS179 * data->P[3][3];
    const float KS181 = 16 * data->P[2][3];
    const float KS182 = KS102 * KS9;
    const float KS183 = KS4 * mag_e;
    const float KS184 = KS183 * KS91 * data->P[3][3];
    const float KS185 = KS5 * KS91;
    const float KS186 = KS185 * mag_e;
    const float KS187 = 16 * KS27;
    const float KS188 = KS9 * data->P[0][2];
    const float KS189 = KS4 * data->P[2][17];
    const float KS190 = 16 * KS32;
    const float KS191 = KS187 * KS5;
    const float KS192 = KS113 * KS26;
    const float KS193 = 8 * KS9;
    const float KS194 = KS193 * KS30;
    const float KS195 = 8 * KS4;
    const float KS196 = KS109 * data->P[0][2];
    const float KS197 = 8 * KS5;
    const float KS198 = KS193 * KS8;
    const float KS199 = KS197 * KS30;
    const float KS200 = KS199 * data->P[3][18];
    const float KS201 = KS113 * KS4;
    const float KS202 = KS201 * data->P[2][18];
    const float KS203 = KS151 * KS4;
    const float KS204 = KS203 * data->P[1][18];
    const float KS205 = KS197 * KS8;
    const float KS206 = KS205 * data->P[0][18];
    const float KS207 = KS197 * KS26;
    const float KS208 = KS193 * KS4;
    const float KS209 = KS195 * KS5;
    const float KS210 = KS209 * data->P[18][18];
    const float KS211 = 8 * KS183;
    const float KS212 = KS197 * mag_e;
    const float KS213 = KS122 * KS8;
    const float KS214 = KS207 * data->P[3][17];
    const float KS215 = KS122 * KS189;
    const float KS216 = KS4 * data->P[3][18];
    const float KS217 = KS208 * data->P[1][17];
    const float KS218 = KS128 * KS5;
    const float KS219 = KS218 * data->P[0][17];
    const float KS220 = KS209 * data->P[17][17];
    const float KS221 = 16 * data->P[2][2];
    const float KS222 = KS102 * KS12 * KS221;
    const float KS223 = data->P[2][3] * mag_d;
    const float KS224 = KS179 * KS32;
    const float KS225 = KS5 * data->P[16][17];
    const float KS226 = KS225 * KS90;
    const float KS227 = KS105 * KS13;
    const float KS228 = KS9 * data->P[1][3];
    const float KS229 = -KS181 * KS227 - KS187 * KS228 - KS226 + KS65 * data->P[16][17] + R_MAG;
    const float KS230 = KS17 * data->P[16][18];
    const float KS231 = KS108 * KS230;
    const float KS232 = -KS185 * KS223 - KS224 * data->P[1][2] - KS231 + KS66 * data->P[16][18];
    const float KS233 = 1.0F / (-KS100 * KS99 - KS101 * KS103 + KS101 * KS32 * data->P[2][16] - KS104 * KS106 + KS104 * KS177 + KS104 * KS27 * data->P[3][16] - KS105 * KS107 - KS105 * KS180 - KS108 * KS110 - KS108 * KS117 + KS110 * KS90 - KS111 * KS112 - KS111 * KS118 - KS111 * KS143 + KS112 * KS144 - KS114 * data->P[0][17] - KS115 - KS116 * KS25 - KS116 * KS26 - KS120 - KS121 + KS122 * KS216 - KS123 * data->P[2][16] - KS125 - KS126 * KS90 - KS127 * KS9 - KS129 * KS20 - KS132 - KS133 * KS134 - KS133 * KS142 + KS133 * KS173 + KS134 * KS163 - KS136 - KS138 - KS140 + KS142 * KS163 + KS144 * KS155 + KS145 * data->P[0][18] + KS145 * data->P[2][16] + KS147 + KS148 + KS149 * data->P[1][18] + KS150 * data->P[0][16] + KS152 * KS72 + KS154 + KS156 * KS90 + KS157 * KS20 + KS158 * data->P[2][17] + KS160 + KS161 * KS72 + KS162 + KS163 * KS169 + KS163 * KS170 + KS164 * data->P[0][2] + KS166 + KS168 + KS172 + KS174 + KS176 + 32 * KS178 * KS92 - KS181 * KS182 - KS184 - KS186 * data->P[2][2] - KS187 * KS188 - KS189 * KS190 + KS190 * KS216 - KS191 * data->P[2][18] - KS191 * data->P[3][17] - KS192 * data->P[2][2] + KS192 * data->P[3][3] - KS194 * data->P[0][3] - KS194 * data->P[1][2] - KS195 * KS196 - KS196 * KS197 - KS198 * data->P[0][0] + KS198 * data->P[1][1] - KS199 * data->P[2][17] - KS20 * KS39 + KS20 * KS76 + KS20 * KS90 * data->P[16][16] + KS20 * KS93 * data->P[2][2] - KS200 + KS201 * data->P[3][17] - KS202 - KS203 * data->P[0][17] - KS204 + KS205 * data->P[1][17] - KS206 - KS207 * data->P[2][18] - KS208 * data->P[0][18] - KS210 + KS211 * KS96 + KS212 * KS96 + KS213 * data->P[0][3] + KS213 * data->P[1][2] + KS214 + KS215 + KS217 + KS218 * data->P[1][18] + KS219 - KS22 * KS39 + KS22 * KS79 + KS22 * KS81 + KS220 + KS222 + KS223 * KS4 * KS91 + KS224 * data->P[0][3] + KS229 + KS232 + KS31 * KS90 * data->P[0][18] + KS35 + KS36 * KS40 + KS36 * KS41 - KS37 - KS38 + KS42 * KS91 * data->P[3][16] - KS43 * data->P[0][16] * mag_e - KS43 * data->P[16][18] * q_x - KS44 * data->P[1][16] + KS45 * KS91 * data->P[2][16] + KS46 * data->P[0][16] * mag_d - KS46 * data->P[16][17] * q_x - KS47 * data->P[1][16] - KS48 * data->P[2][19] - KS49 - KS50 * data->P[3][19] - KS51 - KS52 - KS53 * data->P[2][16] - KS53 * data->P[2][19] - KS54 * data->P[0][16] - KS54 * data->P[0][19] - KS55 * data->P[18][19] - KS56 + KS57 * data->P[3][16] + KS57 * data->P[3][19] + KS58 * data->P[1][16] + KS58 * data->P[1][19] + KS59 * data->P[3][16] + KS59 * data->P[3][19] + KS60 * data->P[2][16] + KS60 * data->P[2][19] + KS61 * data->P[1][16] + KS61 * data->P[1][19] + KS62 * data->P[0][16] + KS62 * data->P[0][19] + KS63 * data->P[17][19] + KS64 + KS65 * data->P[17][19] + KS66 * data->P[18][19] + KS67 * KS69 + KS70 * KS71 + KS70 * KS82 + KS70 * KS85 + KS70 * KS88 + KS72 * KS74 + KS72 * KS78 + KS72 * KS84 + KS86 * KS87 + KS89 + KS93 * KS94 - KS95 * KS96 - KS98 + data->P[16][16] + data->P[19][19]);
    const float KS234 = KS130 + KS141;
    const float KS235 = KS105 + KS8;
    const float KS236 = -KS27;
    const float KS237 = KS236 + KS25;
    const float KS238 = KS4 - KS5;
    const float KS239 = 2 * data->P[0][16];
    const float KS240 = KS30 - 2 * KS31 + KS32;
    const float KS241 = 2 * KS75;
    const float KS242 = KS23 + KS241;
    const float KS243 = KS102 - KS12 + 2 * KS13;
    const float KS244 = 2 * data->P[17][20];
    const float KS245 = 4 * data->P[17][20];
    const float KS246 = powf(q_x, 4);
    const float KS247 = powf(q_x, 3);
    const float KS248 = 8 * KS247;
    const float KS249 = KS248 * mag_n;
    const float KS250 = KS248 * data->P[17][18] * q_w;
    const float KS251 = 4 * KS102;
    const float KS252 = 4 * KS27;
    const float KS253 = 4 * KS105;
    const float KS254 = 4 * KS32;
    const float KS255 = 4 * KS130;
    const float KS256 = KS255 * data->P[17][18];
    const float KS257 = 4 * KS141;
    const float KS258 = 16 * mag_e;
    const float KS259 = 16 * KS70;
    const float KS260 = KS258 * mag_d;
    const float KS261 = KS260 * KS75 * data->P[0][1];
    const float KS262 = KS260 * data->P[2][3];
    const float KS263 = KS75 * KS91;
    const float KS264 = 16 * KS75;
    const float KS265 = KS26 * data->P[1][18];
    const float KS266 = KS175 * mag_n;
    const float KS267 = KS96 * mag_n;
    const float KS268 = KS22 * KS48;
    const float KS269 = KS48 * KS75;
    const float KS270 = KS268 * data->P[1][17];
    const float KS271 = 8 * KS92;
    const float KS272 = KS134 * KS271;
    const float KS273 = KS142 * KS271;
    const float KS274 = KS113 * data->P[1][18];
    const float KS275 = KS102 * data->P[0][16];
    const float KS276 = KS144 * KS177;
    const float KS277 = KS103 * KS144;
    const float KS278 = KS105 * KS108;
    const float KS279 = KS50 * KS75;
    const float KS280 = KS20 * KS50;
    const float KS281 = KS280 * data->P[1][18];
    const float KS282 = KS130 * data->P[0][1];
    const float KS283 = KS144 * KS165;
    const float KS284 = KS135 * KS144;
    const float KS285 = 16 * data->P[1][1];
    const float KS286 = KS25 * KS26 * KS285;
    const float KS287 = KS258 * KS96;
    const float KS288 = KS179 * KS31;
    const float KS289 = 16 * KS31;
    const float KS290 = 16 * KS5;
    const float KS291 = KS13 * KS290;
    const float KS292 = KS102 * KS113;
    const float KS293 = KS102 * KS151;
    const float KS294 = KS195 * mag_n;
    const float KS295 = data->P[0][1] * mag_d;
    const float KS296 = KS105 * KS8;
    const float KS297 = 8 * KS296;
    const float KS298 = KS48 * KS8;
    const float KS299 = KS102 * KS197;
    const float KS300 = KS299 * data->P[3][16];
    const float KS301 = KS105 * KS195;
    const float KS302 = KS301 * data->P[2][16];
    const float KS303 = KS4 * data->P[1][16];
    const float KS304 = KS303 * KS48;
    const float KS305 = KS5 * KS50;
    const float KS306 = KS305 * data->P[0][16];
    const float KS307 = KS209 * data->P[16][16];
    const float KS308 = KS197 * mag_n;
    const float KS309 = KS105 * KS26;
    const float KS310 = KS309 * data->P[1][3];
    const float KS311 = -KS174 + KS257 * data->P[17][18] - KS287 * KS5 - KS288 * data->P[1][2];
    const float KS312 = 1.0F / (-KS100 * KS263 + KS101 * KS26 * data->P[3][16] + KS101 * KS31 * data->P[1][17] + KS103 * KS90 - KS105 * KS127 - KS106 * KS90 - KS107 * KS9 + KS108 * KS155 + KS108 * KS267 - KS111 * KS117 - KS111 * KS230 - KS111 * KS267 + KS115 - KS118 * KS144 - KS122 * data->P[1][20] - KS126 * KS264 - KS128 * data->P[3][20] + KS13 * KS264 * data->P[3][17] + KS133 * KS171 + KS133 * KS178 + KS133 * KS282 + KS138 + KS140 - KS144 * KS146 + KS144 * KS266 + KS144 * KS30 * data->P[0][18] - KS147 - KS148 - KS149 * data->P[0][17] + KS150 * data->P[2][18] - KS150 * data->P[3][17] + KS153 * data->P[0][16] - KS154 - KS157 - KS161 - KS162 + KS164 * data->P[1][3] - KS166 - KS167 * KS271 + KS169 * KS271 + KS170 * KS271 - KS171 * KS271 + 32 * KS173 * KS70 - KS180 * KS9 + KS184 - KS186 * data->P[1][1] + KS199 * data->P[1][16] + KS200 - KS201 * data->P[0][16] + KS202 - KS203 * data->P[3][16] + KS204 + KS205 * data->P[2][16] + KS206 + KS210 - KS216 * KS289 - KS216 * KS48 - KS22 * KS245 - KS22 * KS262 + KS22 * KS78 + KS22 * KS84 - KS223 * KS294 + KS223 * KS308 + 16 * KS227 * data->P[0][1] + KS229 + KS231 + KS244 - KS245 * KS75 + KS246 * KS73 + KS247 * KS258 * data->P[1][17] - KS248 * data->P[0][17] * mag_d - KS248 * data->P[16][17] * q_y - KS249 * data->P[2][17] - KS250 - KS251 * data->P[3][17] - KS251 * data->P[3][20] - KS252 * data->P[0][17] - KS252 * data->P[0][20] + KS253 * data->P[2][17] + KS253 * data->P[2][20] + KS254 * data->P[1][17] + KS254 * data->P[1][20] + KS255 * data->P[18][20] + KS256 + KS257 * data->P[18][20] + KS258 * KS42 * data->P[3][17] + KS259 * KS75 * data->P[1][1] + KS259 * KS94 - KS261 - KS264 * KS265 - KS266 * KS90 - KS268 * data->P[0][18] - KS269 * data->P[1][17] - KS270 - KS272 - KS273 + KS274 * KS72 + KS275 * KS90 + KS276 + KS277 + KS278 * data->P[1][16] + KS279 * data->P[0][17] + KS281 + KS283 + KS284 - KS286 - KS287 * KS4 - KS288 * data->P[0][3] + KS289 * KS303 - KS291 * data->P[1][18] - KS291 * data->P[3][16] - KS292 * data->P[0][3] + KS292 * data->P[1][2] + KS293 * data->P[1][1] - KS293 * data->P[3][3] - KS294 * KS295 + KS295 * KS308 - KS297 * data->P[0][0] + KS297 * data->P[2][2] - KS298 * data->P[0][3] + KS298 * data->P[1][2] + KS299 * data->P[1][18] - KS300 - KS301 * data->P[0][18] - KS302 - KS304 + KS305 * data->P[2][18] - KS306 - KS307 + 16 * KS310 + KS311 + KS37 * KS75 + KS38 * KS72 + KS41 * KS73 + KS43 * data->P[0][17] * mag_n - KS43 * data->P[17][18] * q_y - KS44 * data->P[2][17] + KS49 * KS75 + KS51 * KS72 + KS52 + KS53 * data->P[1][17] + KS53 * data->P[1][20] + KS54 * data->P[3][17] + KS54 * data->P[3][20] + KS57 * data->P[0][17] + KS57 * data->P[0][20] + KS58 * data->P[2][17] + KS58 * data->P[2][20] - KS63 * data->P[16][20] - KS64 + KS65 * data->P[16][20] + KS67 * KS87 + KS69 * KS86 + KS71 * KS92 + KS72 * KS79 + KS72 * KS81 - KS74 + KS75 * KS90 * data->P[17][17] - KS76 + KS82 * KS92 + KS85 * KS92 + KS88 * KS92 + KS98 + data->P[17][17] + data->P[20][20]);
    const float KS313 = KS16 + KS17;
    const float KS314 = KS105 + KS9;
    const float KS315 = KS31 - KS32;
    const float KS316 = KS130 - KS141;
    const float KS317 = KS21 + KS241 - 1;
    const float KS318 = KS102 - 2 * KS12 + KS13;
    const float KS319 = KS236 + 2 * KS25 + KS26;
    const float KS320 = 2 * data->P[18][21];
    const float KS321 = 4 * data->P[18][21];
    const float KS322 = 16 * mag_d;
    const float KS323 = KS97 * mag_n;
    const float KS324 = KS100 * mag_n;
    const float KS325 = 16 * data->P[1][2];
    const float KS326 = KS290 * KS30;
    const float KS327 = KS179 * KS5;
    const float KS328 = 8 * KS182;
    const float KS329 = KS211 * mag_n;
    const float KS330 = KS212 * mag_n;
    const float KS331 = KS105 * KS128;
    const float KS332 = 1.0F / (-KS102 * KS25 * KS325 - KS104 * KS118 + KS104 * KS25 * data->P[1][18] - KS104 * KS30 * data->P[2][16] + KS105 * KS90 * data->P[1][16] - KS106 * KS111 - KS108 * KS177 + KS108 * KS275 + KS108 * KS323 + KS108 * KS75 * data->P[18][18] - KS111 * KS126 - KS111 * KS225 - KS111 * KS324 - KS113 * data->P[1][21] - KS117 * KS264 + KS12 * KS264 * data->P[2][18] + KS120 + KS121 - KS122 * KS303 + KS123 * data->P[0][18] + KS125 - KS129 * KS75 + KS132 + KS136 - KS137 * KS163 + KS137 * KS271 - KS139 * KS163 + KS139 * KS271 + KS144 * KS156 + KS144 * KS265 - KS144 * KS323 + KS146 * KS264 - KS151 * data->P[2][21] - KS152 + KS157 * KS72 - KS158 * data->P[3][18] - KS159 * KS20 + KS16 * KS271 * data->P[0][2] - KS160 + KS161 * KS20 + KS163 * KS178 + KS163 * KS282 - KS168 + 32 * KS170 * KS68 - KS172 + KS173 * KS271 + KS175 * KS258 * KS5 - KS176 - KS185 * KS295 + KS188 * KS50 + KS189 * KS48 - KS20 * KS262 - KS20 * KS321 + KS20 * KS67 * KS92 + KS20 * KS70 * KS86 + KS20 * KS74 - KS207 * data->P[0][16] + KS208 * data->P[2][16] - KS214 - KS215 - KS217 + KS218 * data->P[3][16] - KS219 + KS22 * KS70 * KS83 + KS22 * KS80 * KS92 - KS220 + KS221 * KS69 - KS221 * KS8 * KS9 - KS222 + KS226 + KS228 * KS50 + KS232 + KS246 * KS77 + KS247 * KS322 * data->P[1][18] + KS248 * data->P[0][18] * mag_e - KS248 * data->P[16][18] * q_z - KS249 * data->P[3][18] + KS250 + KS251 * data->P[2][18] + KS251 * data->P[2][21] + KS252 * data->P[1][18] + KS252 * data->P[1][21] + KS253 * data->P[3][18] + KS253 * data->P[3][21] + KS254 * data->P[0][18] + KS254 * data->P[0][21] - KS255 * data->P[17][21] - KS256 + KS257 * data->P[17][21] + KS261 - KS263 * KS96 - KS269 * data->P[0][18] + KS270 + KS272 + KS273 - KS274 - KS276 - KS277 - KS278 * data->P[3][18] - KS279 * data->P[1][18] + KS280 * data->P[0][17] - KS281 - KS283 - KS284 - KS285 * KS296 + KS285 * KS87 + KS286 - KS299 * data->P[0][17] + KS30 * KS325 * KS9 + KS300 - KS301 * data->P[1][17] + KS302 + KS304 + KS305 * data->P[3][17] + KS306 + KS307 - 8 * KS309 * data->P[0][2] - 8 * KS310 + KS311 + KS320 - KS321 * KS75 + KS322 * KS45 * data->P[2][18] + KS324 * KS90 - KS326 * data->P[1][16] + KS326 * data->P[2][17] - KS327 * data->P[1][17] - KS327 * data->P[2][16] - KS328 * data->P[0][1] + KS328 * data->P[2][3] - KS329 * data->P[1][1] + KS329 * data->P[2][2] - KS330 * data->P[0][0] + KS330 * data->P[3][3] - KS331 * data->P[0][1] + KS331 * data->P[2][3] + KS37 * KS72 + KS38 * KS75 + KS40 * KS77 - KS46 * data->P[0][18] * mag_n - KS46 * data->P[17][18] * q_z - KS47 * data->P[3][18] + KS49 * KS72 + KS51 * KS75 + KS55 * data->P[16][21] + KS56 - KS59 * data->P[1][18] - KS59 * data->P[1][21] - KS60 * data->P[0][18] - KS60 * data->P[0][21] + KS61 * data->P[3][18] + KS61 * data->P[3][21] + KS62 * data->P[2][18] + KS62 * data->P[2][21] + KS66 * data->P[16][21] + KS67 * KS70 * KS75 + KS70 * KS72 * KS80 + KS72 * KS76 + KS72 * KS83 * KS92 + KS75 * KS86 * KS92 - KS78 - KS79 - KS89 + KS9 * KS90 * data->P[2][17] + data->P[18][18] + data->P[21][21] + R_MAG);
    const float KS333 = 2 * data->P[1][17];
    const float KS334 = 2 * data->P[1][1];
    const float KS335 = 2 * data->P[1][18];
    const float KS336 = 2 * data->P[1][3];
    const float KS337 = 2 * data->P[1][2];
    const float KS338 = 2 * data->P[1][16];
    const float KS339 = 2 * data->P[2][17];
    const float KS340 = 2 * data->P[2][18];
    const float KS341 = 2 * data->P[2][3];
    const float KS342 = 2 * data->P[2][2];
    const float KS343 = 2 * data->P[2][16];
    const float KS344 = 2 * data->P[3][17];
    const float KS345 = 2 * data->P[3][18];
    const float KS346 = 2 * data->P[3][3];
    const float KS347 = 2 * data->P[3][16];
    const float KS348 = 2 * data->P[1][4];
    const float KS349 = 2 * data->P[4][17];
    const float KS350 = 2 * data->P[0][4];
    const float KS351 = 2 * data->P[4][18];
    const float KS352 = 2 * data->P[3][4];
    const float KS353 = 2 * data->P[2][4];
    const float KS354 = 2 * data->P[4][16];
    const float KS355 = 2 * data->P[1][5];
    const float KS356 = 2 * data->P[5][17];
    const float KS357 = 2 * data->P[0][5];
    const float KS358 = 2 * data->P[5][18];
    const float KS359 = 2 * data->P[3][5];
    const float KS360 = 2 * data->P[2][5];
    const float KS361 = 2 * data->P[5][16];
    const float KS362 = 2 * data->P[1][6];
    const float KS363 = 2 * data->P[6][17];
    const float KS364 = 2 * data->P[0][6];
    const float KS365 = 2 * data->P[6][18];
    const float KS366 = 2 * data->P[3][6];
    const float KS367 = 2 * data->P[2][6];
    const float KS368 = 2 * data->P[6][16];
    const float KS369 = 2 * data->P[1][7];
    const float KS370 = 2 * data->P[7][17];
    const float KS371 = 2 * data->P[0][7];
    const float KS372 = 2 * data->P[7][18];
    const float KS373 = 2 * data->P[3][7];
    const float KS374 = 2 * data->P[2][7];
    const float KS375 = 2 * data->P[7][16];
    const float KS376 = 2 * data->P[1][8];
    const float KS377 = 2 * data->P[8][17];
    const float KS378 = 2 * data->P[0][8];
    const float KS379 = 2 * data->P[8][18];
    const float KS380 = 2 * data->P[3][8];
    const float KS381 = 2 * data->P[2][8];
    const float KS382 = 2 * data->P[8][16];
    const float KS383 = 2 * data->P[1][9];
    const float KS384 = 2 * data->P[9][17];
    const float KS385 = 2 * data->P[0][9];
    const float KS386 = 2 * data->P[9][18];
    const float KS387 = 2 * data->P[3][9];
    const float KS388 = 2 * data->P[2][9];
    const float KS389 = 2 * data->P[9][16];
    const float KS390 = 2 * data->P[10][17];
    const float KS391 = 2 * data->P[1][10];
    const float KS392 = 2 * data->P[0][10];
    const float KS393 = 2 * data->P[10][18];
    const float KS394 = 2 * data->P[3][10];
    const float KS395 = 2 * data->P[2][10];
    const float KS396 = 2 * data->P[10][16];
    const float KS397 = 2 * data->P[11][17];
    const float KS398 = 2 * data->P[1][11];
    const float KS399 = 2 * data->P[0][11];
    const float KS400 = 2 * data->P[11][18];
    const float KS401 = 2 * data->P[3][11];
    const float KS402 = 2 * data->P[2][11];
    const float KS403 = 2 * data->P[11][16];
    const float KS404 = 2 * data->P[12][17];
    const float KS405 = 2 * data->P[1][12];
    const float KS406 = 2 * data->P[0][12];
    const float KS407 = 2 * data->P[12][18];
    const float KS408 = 2 * data->P[3][12];
    const float KS409 = 2 * data->P[2][12];
    const float KS410 = 2 * data->P[12][16];
    const float KS411 = 2 * data->P[13][17];
    const float KS412 = 2 * data->P[1][13];
    const float KS413 = 2 * data->P[0][13];
    const float KS414 = 2 * data->P[13][18];
    const float KS415 = 2 * data->P[3][13];
    const float KS416 = 2 * data->P[2][13];
    const float KS417 = 2 * data->P[13][16];
    const float KS418 = 2 * data->P[14][17];
    const float KS419 = 2 * data->P[1][14];
    const float KS420 = 2 * data->P[0][14];
    const float KS421 = 2 * data->P[14][18];
    const float KS422 = 2 * data->P[3][14];
    const float KS423 = 2 * data->P[2][14];
    const float KS424 = 2 * data->P[14][16];
    const float KS425 = 2 * data->P[15][17];
    const float KS426 = 2 * data->P[1][15];
    const float KS427 = 2 * data->P[0][15];
    const float KS428 = 2 * data->P[15][18];
    const float KS429 = 2 * data->P[3][15];
    const float KS430 = 2 * data->P[2][15];
    const float KS431 = 2 * data->P[15][16];
    const float KS432 = 2 * data->P[16][17];
    const float KS433 = 2 * data->P[16][18];
    const float KS434 = 2 * data->P[16][16];
    const float KS435 = 2 * data->P[17][17];
    const float KS436 = 2 * data->P[17][18];
    const float KS437 = 2 * data->P[18][18];
    const float KS438 = 2 * data->P[17][19];
    const float KS439 = 2 * data->P[1][19];
    const float KS440 = 2 * data->P[0][19];
    const float KS441 = 2 * data->P[18][19];
    const float KS442 = 2 * data->P[3][19];
    const float KS443 = 2 * data->P[2][19];
    const float KS444 = -data->P[19][21];
    const float KS445 = 2 * data->P[1][20];
    const float KS446 = 2 * data->P[0][20];
    const float KS447 = 2 * data->P[18][20];
    const float KS448 = 2 * data->P[3][20];
    const float KS449 = 2 * data->P[2][20];
    const float KS450 = 2 * data->P[16][20];
    const float KS451 = 2 * data->P[17][21];
    const float KS452 = 2 * data->P[1][21];
    const float KS453 = 2 * data->P[0][21];
    const float KS454 = 2 * data->P[3][21];
    const float KS455 = 2 * data->P[2][21];
    const float KS456 = 2 * data->P[16][21];

    data->K[0][0] = KS0 * data->P[0][7];
    data->K[1][0] = KS0 * data->P[1][7];
    data->K[2][0] = KS0 * data->P[2][7];
    data->K[3][0] = KS0 * data->P[3][7];
    data->K[4][0] = KS0 * data->P[4][7];
    data->K[5][0] = KS0 * data->P[5][7];
    data->K[6][0] = KS0 * data->P[6][7];
    data->K[7][0] = KS0 * data->P[7][7];
    data->K[8][0] = KS0 * data->P[7][8];
    data->K[9][0] = KS0 * data->P[7][9];
    data->K[10][0] = KS0 * data->P[7][10];
    data->K[11][0] = KS0 * data->P[7][11];
    data->K[12][0] = KS0 * data->P[7][12];
    data->K[13][0] = KS0 * data->P[7][13];
    data->K[14][0] = KS0 * data->P[7][14];
    data->K[15][0] = KS0 * data->P[7][15];
    data->K[16][0] = KS0 * data->P[7][16];
    data->K[17][0] = KS0 * data->P[7][17];
    data->K[18][0] = KS0 * data->P[7][18];
    data->K[19][0] = KS0 * data->P[7][19];
    data->K[20][0] = KS0 * data->P[7][20];
    data->K[21][0] = KS0 * data->P[7][21];
    data->K[0][1] = KS1 * data->P[0][8];
    data->K[1][1] = KS1 * data->P[1][8];
    data->K[2][1] = KS1 * data->P[2][8];
    data->K[3][1] = KS1 * data->P[3][8];
    data->K[4][1] = KS1 * data->P[4][8];
    data->K[5][1] = KS1 * data->P[5][8];
    data->K[6][1] = KS1 * data->P[6][8];
    data->K[7][1] = KS1 * data->P[7][8];
    data->K[8][1] = KS1 * data->P[8][8];
    data->K[9][1] = KS1 * data->P[8][9];
    data->K[10][1] = KS1 * data->P[8][10];
    data->K[11][1] = KS1 * data->P[8][11];
    data->K[12][1] = KS1 * data->P[8][12];
    data->K[13][1] = KS1 * data->P[8][13];
    data->K[14][1] = KS1 * data->P[8][14];
    data->K[15][1] = KS1 * data->P[8][15];
    data->K[16][1] = KS1 * data->P[8][16];
    data->K[17][1] = KS1 * data->P[8][17];
    data->K[18][1] = KS1 * data->P[8][18];
    data->K[19][1] = KS1 * data->P[8][19];
    data->K[20][1] = KS1 * data->P[8][20];
    data->K[21][1] = KS1 * data->P[8][21];
    data->K[0][2] = KS2 * data->P[0][9];
    data->K[1][2] = KS2 * data->P[1][9];
    data->K[2][2] = KS2 * data->P[2][9];
    data->K[3][2] = KS2 * data->P[3][9];
    data->K[4][2] = KS2 * data->P[4][9];
    data->K[5][2] = KS2 * data->P[5][9];
    data->K[6][2] = KS2 * data->P[6][9];
    data->K[7][2] = KS2 * data->P[7][9];
    data->K[8][2] = KS2 * data->P[8][9];
    data->K[9][2] = KS2 * data->P[9][9];
    data->K[10][2] = KS2 * data->P[9][10];
    data->K[11][2] = KS2 * data->P[9][11];
    data->K[12][2] = KS2 * data->P[9][12];
    data->K[13][2] = KS2 * data->P[9][13];
    data->K[14][2] = KS2 * data->P[9][14];
    data->K[15][2] = KS2 * data->P[9][15];
    data->K[16][2] = KS2 * data->P[9][16];
    data->K[17][2] = KS2 * data->P[9][17];
    data->K[18][2] = KS2 * data->P[9][18];
    data->K[19][2] = KS2 * data->P[9][19];
    data->K[20][2] = KS2 * data->P[9][20];
    data->K[21][2] = KS2 * data->P[9][21];
    data->K[0][3] = KS3 * data->P[0][9];
    data->K[1][3] = KS3 * data->P[1][9];
    data->K[2][3] = KS3 * data->P[2][9];
    data->K[3][3] = KS3 * data->P[3][9];
    data->K[4][3] = KS3 * data->P[4][9];
    data->K[5][3] = KS3 * data->P[5][9];
    data->K[6][3] = KS3 * data->P[6][9];
    data->K[7][3] = KS3 * data->P[7][9];
    data->K[8][3] = KS3 * data->P[8][9];
    data->K[9][3] = KS3 * data->P[9][9];
    data->K[10][3] = KS3 * data->P[9][10];
    data->K[11][3] = KS3 * data->P[9][11];
    data->K[12][3] = KS3 * data->P[9][12];
    data->K[13][3] = KS3 * data->P[9][13];
    data->K[14][3] = KS3 * data->P[9][14];
    data->K[15][3] = KS3 * data->P[9][15];
    data->K[16][3] = KS3 * data->P[9][16];
    data->K[17][3] = KS3 * data->P[9][17];
    data->K[18][3] = KS3 * data->P[9][18];
    data->K[19][3] = KS3 * data->P[9][19];
    data->K[20][3] = KS3 * data->P[9][20];
    data->K[21][3] = KS3 * data->P[9][21];
    data->K[0][4] = -KS233 * (-KS10 * KS11 + KS14 * KS15 + KS18 * KS19 + KS24 * data->P[0][16] - KS28 * KS29 + KS33 * KS34 - KS6 * KS7 - data->P[0][19]);
    data->K[1][4] = -KS233 * (-KS10 * KS334 + KS11 * KS14 + KS18 * KS335 + KS24 * data->P[1][16] - KS28 * KS336 + KS33 * KS337 - KS333 * KS6 - data->P[1][19]);
    data->K[2][4] = -KS233 * (-KS10 * KS337 + KS14 * KS34 + KS18 * KS340 + KS24 * data->P[2][16] - KS28 * KS341 + KS33 * KS342 - KS339 * KS6 - data->P[2][19]);
    data->K[3][4] = -KS233 * (-KS10 * KS336 + KS14 * KS29 + KS18 * KS345 + KS24 * data->P[3][16] - KS28 * KS346 + KS33 * KS341 - KS344 * KS6 - data->P[3][19]);
    data->K[4][4] = -KS233 * (-KS10 * KS348 + KS14 * KS350 + KS18 * KS351 + KS24 * data->P[4][16] - KS28 * KS352 + KS33 * KS353 - KS349 * KS6 - data->P[4][19]);
    data->K[5][4] = -KS233 * (-KS10 * KS355 + KS14 * KS357 + KS18 * KS358 + KS24 * data->P[5][16] - KS28 * KS359 + KS33 * KS360 - KS356 * KS6 - data->P[5][19]);
    data->K[6][4] = -KS233 * (-KS10 * KS362 + KS14 * KS364 + KS18 * KS365 + KS24 * data->P[6][16] - KS28 * KS366 + KS33 * KS367 - KS363 * KS6 - data->P[6][19]);
    data->K[7][4] = -KS233 * (-KS10 * KS369 + KS14 * KS371 + KS18 * KS372 + KS24 * data->P[7][16] - KS28 * KS373 + KS33 * KS374 - KS370 * KS6 - data->P[7][19]);
    data->K[8][4] = -KS233 * (-KS10 * KS376 + KS14 * KS378 + KS18 * KS379 + KS24 * data->P[8][16] - KS28 * KS380 + KS33 * KS381 - KS377 * KS6 - data->P[8][19]);
    data->K[9][4] = -KS233 * (-KS10 * KS383 + KS14 * KS385 + KS18 * KS386 + KS24 * data->P[9][16] - KS28 * KS387 + KS33 * KS388 - KS384 * KS6 - data->P[9][19]);
    data->K[10][4] = -KS233 * (-KS10 * KS391 + KS14 * KS392 + KS18 * KS393 + KS24 * data->P[10][16] - KS28 * KS394 + KS33 * KS395 - KS390 * KS6 - data->P[10][19]);
    data->K[11][4] = -KS233 * (-KS10 * KS398 + KS14 * KS399 + KS18 * KS400 + KS24 * data->P[11][16] - KS28 * KS401 + KS33 * KS402 - KS397 * KS6 - data->P[11][19]);
    data->K[12][4] = -KS233 * (-KS10 * KS405 + KS14 * KS406 + KS18 * KS407 + KS24 * data->P[12][16] - KS28 * KS408 + KS33 * KS409 - KS404 * KS6 - data->P[12][19]);
    data->K[13][4] = -KS233 * (-KS10 * KS412 + KS14 * KS413 + KS18 * KS414 + KS24 * data->P[13][16] - KS28 * KS415 + KS33 * KS416 - KS411 * KS6 - data->P[13][19]);
    data->K[14][4] = -KS233 * (-KS10 * KS419 + KS14 * KS420 + KS18 * KS421 + KS24 * data->P[14][16] - KS28 * KS422 + KS33 * KS423 - KS418 * KS6 - data->P[14][19]);
    data->K[15][4] = -KS233 * (-KS10 * KS426 + KS14 * KS427 + KS18 * KS428 + KS24 * data->P[15][16] - KS28 * KS429 + KS33 * KS430 - KS425 * KS6 - data->P[15][19]);
    data->K[16][4] = -KS233 * (-KS10 * KS338 + KS14 * KS239 + KS18 * KS433 + KS24 * data->P[16][16] - KS28 * KS347 + KS33 * KS343 - KS432 * KS6 - data->P[16][19]);
    data->K[17][4] = -KS233 * (-KS10 * KS333 + KS14 * KS7 + KS18 * KS436 + KS24 * data->P[16][17] - KS28 * KS344 + KS33 * KS339 - KS435 * KS6 - data->P[17][19]);
    data->K[18][4] = -KS233 * (-KS10 * KS335 + KS14 * KS19 + KS18 * KS437 + KS24 * data->P[16][18] - KS28 * KS345 + KS33 * KS340 - KS436 * KS6 - data->P[18][19]);
    data->K[19][4] = -KS233 * (-KS10 * KS439 + KS14 * KS440 + KS18 * KS441 + KS24 * data->P[16][19] - KS28 * KS442 + KS33 * KS443 - KS438 * KS6 - data->P[19][19]);
    data->K[20][4] = -KS233 * (-KS10 * KS445 + KS14 * KS446 + KS18 * KS447 + KS24 * data->P[16][20] - KS244 * KS6 - KS28 * KS448 + KS33 * KS449 - data->P[19][20]);
    data->K[21][4] = -KS233 * (-KS10 * KS452 + KS14 * KS453 + KS18 * KS320 + KS24 * data->P[16][21] - KS28 * KS454 + KS33 * KS455 + KS444 - KS451 * KS6);
    data->K[0][5] = KS312 * (KS11 * KS240 + KS15 * KS237 + KS19 * KS234 + KS235 * KS34 - KS238 * KS239 - KS242 * data->P[0][17] - KS243 * KS29 + data->P[0][20]);
    data->K[1][5] = KS312 * (KS11 * KS237 + KS234 * KS335 + KS235 * KS337 - KS238 * KS338 + KS240 * KS334 - KS242 * data->P[1][17] - KS243 * KS336 + data->P[1][20]);
    data->K[2][5] = KS312 * (KS234 * KS340 + KS235 * KS342 + KS237 * KS34 - KS238 * KS343 + KS240 * KS337 - KS242 * data->P[2][17] - KS243 * KS341 + data->P[2][20]);
    data->K[3][5] = KS312 * (KS234 * KS345 + KS235 * KS341 + KS237 * KS29 - KS238 * KS347 + KS240 * KS336 - KS242 * data->P[3][17] - KS243 * KS346 + data->P[3][20]);
    data->K[4][5] = KS312 * (KS234 * KS351 + KS235 * KS353 + KS237 * KS350 - KS238 * KS354 + KS240 * KS348 - KS242 * data->P[4][17] - KS243 * KS352 + data->P[4][20]);
    data->K[5][5] = KS312 * (KS234 * KS358 + KS235 * KS360 + KS237 * KS357 - KS238 * KS361 + KS240 * KS355 - KS242 * data->P[5][17] - KS243 * KS359 + data->P[5][20]);
    data->K[6][5] = KS312 * (KS234 * KS365 + KS235 * KS367 + KS237 * KS364 - KS238 * KS368 + KS240 * KS362 - KS242 * data->P[6][17] - KS243 * KS366 + data->P[6][20]);
    data->K[7][5] = KS312 * (KS234 * KS372 + KS235 * KS374 + KS237 * KS371 - KS238 * KS375 + KS240 * KS369 - KS242 * data->P[7][17] - KS243 * KS373 + data->P[7][20]);
    data->K[8][5] = KS312 * (KS234 * KS379 + KS235 * KS381 + KS237 * KS378 - KS238 * KS382 + KS240 * KS376 - KS242 * data->P[8][17] - KS243 * KS380 + data->P[8][20]);
    data->K[9][5] = KS312 * (KS234 * KS386 + KS235 * KS388 + KS237 * KS385 - KS238 * KS389 + KS240 * KS383 - KS242 * data->P[9][17] - KS243 * KS387 + data->P[9][20]);
    data->K[10][5] = KS312 * (KS234 * KS393 + KS235 * KS395 + KS237 * KS392 - KS238 * KS396 + KS240 * KS391 - KS242 * data->P[10][17] - KS243 * KS394 + data->P[10][20]);
    data->K[11][5] = KS312 * (KS234 * KS400 + KS235 * KS402 + KS237 * KS399 - KS238 * KS403 + KS240 * KS398 - KS242 * data->P[11][17] - KS243 * KS401 + data->P[11][20]);
    data->K[12][5] = KS312 * (KS234 * KS407 + KS235 * KS409 + KS237 * KS406 - KS238 * KS410 + KS240 * KS405 - KS242 * data->P[12][17] - KS243 * KS408 + data->P[12][20]);
    data->K[13][5] = KS312 * (KS234 * KS414 + KS235 * KS416 + KS237 * KS413 - KS238 * KS417 + KS240 * KS412 - KS242 * data->P[13][17] - KS243 * KS415 + data->P[13][20]);
    data->K[14][5] = KS312 * (KS234 * KS421 + KS235 * KS423 + KS237 * KS420 - KS238 * KS424 + KS240 * KS419 - KS242 * data->P[14][17] - KS243 * KS422 + data->P[14][20]);
    data->K[15][5] = KS312 * (KS234 * KS428 + KS235 * KS430 + KS237 * KS427 - KS238 * KS431 + KS240 * KS426 - KS242 * data->P[15][17] - KS243 * KS429 + data->P[15][20]);
    data->K[16][5] = KS312 * (KS234 * KS433 + KS235 * KS343 + KS237 * KS239 - KS238 * KS434 + KS240 * KS338 - KS242 * data->P[16][17] - KS243 * KS347 + data->P[16][20]);
    data->K[17][5] = KS312 * (KS234 * KS436 + KS235 * KS339 + KS237 * KS7 - KS238 * KS432 + KS240 * KS333 - KS242 * data->P[17][17] - KS243 * KS344 + data->P[17][20]);
    data->K[18][5] = KS312 * (KS19 * KS237 + KS234 * KS437 + KS235 * KS340 - KS238 * KS433 + KS240 * KS335 - KS242 * data->P[17][18] - KS243 * KS345 + data->P[18][20]);
    data->K[19][5] = KS312 * (KS234 * KS441 + KS235 * KS443 + KS237 * KS440 - KS238 * KS35 + KS240 * KS439 - KS242 * data->P[17][19] - KS243 * KS442 + data->P[19][20]);
    data->K[20][5] = KS312 * (KS234 * KS447 + KS235 * KS449 + KS237 * KS446 - KS238 * KS450 + KS240 * KS445 - KS242 * data->P[17][20] - KS243 * KS448 + data->P[20][20]);
    data->K[21][5] = KS312 * (KS234 * KS320 + KS235 * KS455 + KS237 * KS453 - KS238 * KS456 + KS240 * KS452 - KS242 * data->P[17][21] - KS243 * KS454 + data->P[20][21]);
    data->K[0][6] = -KS332 * (KS11 * KS319 + KS15 * KS315 - KS239 * KS313 - KS29 * KS314 + KS316 * KS7 + KS317 * data->P[0][18] - KS318 * KS34 - data->P[0][21]);
    data->K[1][6] = -KS332 * (KS11 * KS315 - KS313 * KS338 - KS314 * KS336 + KS316 * KS333 + KS317 * data->P[1][18] - KS318 * KS337 + KS319 * KS334 - data->P[1][21]);
    data->K[2][6] = -KS332 * (-KS313 * KS343 - KS314 * KS341 + KS315 * KS34 + KS316 * KS339 + KS317 * data->P[2][18] - KS318 * KS342 + KS319 * KS337 - data->P[2][21]);
    data->K[3][6] = -KS332 * (KS29 * KS315 - KS313 * KS347 - KS314 * KS346 + KS316 * KS344 + KS317 * data->P[3][18] - KS318 * KS341 + KS319 * KS336 - data->P[3][21]);
    data->K[4][6] = -KS332 * (-KS313 * KS354 - KS314 * KS352 + KS315 * KS350 + KS316 * KS349 + KS317 * data->P[4][18] - KS318 * KS353 + KS319 * KS348 - data->P[4][21]);
    data->K[5][6] = -KS332 * (-KS313 * KS361 - KS314 * KS359 + KS315 * KS357 + KS316 * KS356 + KS317 * data->P[5][18] - KS318 * KS360 + KS319 * KS355 - data->P[5][21]);
    data->K[6][6] = -KS332 * (-KS313 * KS368 - KS314 * KS366 + KS315 * KS364 + KS316 * KS363 + KS317 * data->P[6][18] - KS318 * KS367 + KS319 * KS362 - data->P[6][21]);
    data->K[7][6] = -KS332 * (-KS313 * KS375 - KS314 * KS373 + KS315 * KS371 + KS316 * KS370 + KS317 * data->P[7][18] - KS318 * KS374 + KS319 * KS369 - data->P[7][21]);
    data->K[8][6] = -KS332 * (-KS313 * KS382 - KS314 * KS380 + KS315 * KS378 + KS316 * KS377 + KS317 * data->P[8][18] - KS318 * KS381 + KS319 * KS376 - data->P[8][21]);
    data->K[9][6] = -KS332 * (-KS313 * KS389 - KS314 * KS387 + KS315 * KS385 + KS316 * KS384 + KS317 * data->P[9][18] - KS318 * KS388 + KS319 * KS383 - data->P[9][21]);
    data->K[10][6] = -KS332 * (-KS313 * KS396 - KS314 * KS394 + KS315 * KS392 + KS316 * KS390 + KS317 * data->P[10][18] - KS318 * KS395 + KS319 * KS391 - data->P[10][21]);
    data->K[11][6] = -KS332 * (-KS313 * KS403 - KS314 * KS401 + KS315 * KS399 + KS316 * KS397 + KS317 * data->P[11][18] - KS318 * KS402 + KS319 * KS398 - data->P[11][21]);
    data->K[12][6] = -KS332 * (-KS313 * KS410 - KS314 * KS408 + KS315 * KS406 + KS316 * KS404 + KS317 * data->P[12][18] - KS318 * KS409 + KS319 * KS405 - data->P[12][21]);
    data->K[13][6] = -KS332 * (-KS313 * KS417 - KS314 * KS415 + KS315 * KS413 + KS316 * KS411 + KS317 * data->P[13][18] - KS318 * KS416 + KS319 * KS412 - data->P[13][21]);
    data->K[14][6] = -KS332 * (-KS313 * KS424 - KS314 * KS422 + KS315 * KS420 + KS316 * KS418 + KS317 * data->P[14][18] - KS318 * KS423 + KS319 * KS419 - data->P[14][21]);
    data->K[15][6] = -KS332 * (-KS313 * KS431 - KS314 * KS429 + KS315 * KS427 + KS316 * KS425 + KS317 * data->P[15][18] - KS318 * KS430 + KS319 * KS426 - data->P[15][21]);
    data->K[16][6] = -KS332 * (KS239 * KS315 - KS313 * KS434 - KS314 * KS347 + KS316 * KS432 + KS317 * data->P[16][18] - KS318 * KS343 + KS319 * KS338 - data->P[16][21]);
    data->K[17][6] = -KS332 * (-KS313 * KS432 - KS314 * KS344 + KS315 * KS7 + KS316 * KS435 + KS317 * data->P[17][18] - KS318 * KS339 + KS319 * KS333 - data->P[17][21]);
    data->K[18][6] = -KS332 * (KS19 * KS315 - KS313 * KS433 - KS314 * KS345 + KS316 * KS436 + KS317 * data->P[18][18] - KS318 * KS340 + KS319 * KS335 - data->P[18][21]);
    data->K[19][6] = -KS332 * (-KS313 * KS35 - KS314 * KS442 + KS315 * KS440 + KS316 * KS438 + KS317 * data->P[18][19] - KS318 * KS443 + KS319 * KS439 + KS444);
    data->K[20][6] = -KS332 * (KS244 * KS316 - KS313 * KS450 - KS314 * KS448 + KS315 * KS446 + KS317 * data->P[18][20] - KS318 * KS449 + KS319 * KS445 - data->P[20][21]);
    data->K[21][6] = -KS332 * (-KS313 * KS456 - KS314 * KS454 + KS315 * KS453 + KS316 * KS451 + KS317 * data->P[18][21] - KS318 * KS455 + KS319 * KS452 - data->P[21][21]);

    quat_t quatCopy = data->state.orientation;
    quat_conj(&quatCopy);

    vec3_t magCopy = data->state.mag_ned;
    rotate_vec_through_quat(&magCopy, &quatCopy);
    magCopy = vec3_add(&magCopy, &data->state.magBias);

    float innov[EKF_NUM_MEASUREMENTS];
    innov[0] = inputs->gps.x - data->state.position_ned.x;
    innov[1] = inputs->gps.y - data->state.position_ned.y;
    innov[2] = inputs->gps.z - data->state.position_ned.z;
    innov[3] = inputs->baroHeight - data->state.position_ned.z;
    innov[4] = inputs->mag.x - magCopy.x;
    innov[5] = inputs->mag.y - magCopy.y;
    innov[6] = inputs->mag.z - magCopy.z;

    float *states_arr = (float *)(&data->state);

    for (size_t i = 0; i < EKF_NUM_STATES; i++)
    {
        float tmp = 0.0f;

        for (size_t j = 0; j < EKF_NUM_MEASUREMENTS; j++)
        {
            tmp += data->K[i][j] * innov[j];
        }

        states_arr[i] += tmp;
    }

    quat_normalize(&data->state.orientation);

    for (size_t i = 0; i < EKF_NUM_STATES; i++)
    {
        for (size_t j = 0; j < EKF_NUM_STATES; j++)
        {
            float tmp = 0.0f;

            for (size_t k = 0; k < EKF_NUM_MEASUREMENTS; k++)
            {
                tmp += data->K[i][k] * data->H[k][j];
            }

            data->KH[i][j] = tmp;
        }
    }

    for (size_t i = 0; i < EKF_NUM_STATES; i++)
    {
        for (size_t j = 0; j < EKF_NUM_STATES; j++)
        {
            float tmp = 0.0f;

            for (size_t k = 0; k < EKF_NUM_STATES; k++)
            {
                tmp += data->KH[i][k] * data->P[k][j];
            }

            data->P[i][j] = data->P[i][j] - tmp;
        }
    }
}